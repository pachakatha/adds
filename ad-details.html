<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∂Ø‡∑ê‡∂±‡∑ä‡∑Ä‡∑ì‡∂∏‡∑ä ‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª | Adds.ink</title>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">

    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <div class="bg-white rounded-3xl shadow-lg overflow-hidden border border-gray-100">
            
            <div id="adImageContainer" class="h-64 md:h-96 bg-gray-200">
                <img id="adImage" src="" class="w-full h-full object-cover">
            </div>

            <div class="p-6">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h1 id="adTitle" class="text-2xl font-bold text-gray-800">Loading...</h1>
                        <p id="adLocation" class="text-gray-500 text-sm">üìç Loading...</p>
                    </div>
                    <div class="text-right">
                        <p id="adPrice" class="text-2xl font-black text-orange-600">‡∂ª‡∑î. 0</p>
                    </div>
                </div>

                <hr class="my-4 border-gray-100">

                <div class="bg-orange-50 p-4 rounded-2xl flex items-center justify-between mb-6">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 bg-orange-500 rounded-full flex items-center justify-center text-white font-bold text-xl" id="sellerInitial">S</div>
                        <div>
                            <p class="font-bold text-gray-800" id="sellerName">Seller Name</p>
                            <div id="sellerRating" class="flex items-center text-yellow-500 text-sm font-bold">
                                </div>
                        </div>
                    </div>
                    <button onclick="openChat()" class="bg-white text-orange-600 border border-orange-600 px-4 py-2 rounded-xl font-bold hover:bg-orange-600 hover:text-white transition">
                        Chat ‡∂ö‡∂ª‡∂±‡∑ä‡∂±
                    </button>
                </div>

                <div class="mb-8">
                    <h3 class="font-bold text-lg mb-2">‡∂Ø‡∑ê‡∂±‡∑ä‡∑Ä‡∑ì‡∂∏‡∑ö ‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª:</h3>
                    <p id="adDescription" class="text-gray-600 leading-relaxed text-sm">Loading description...</p>
                </div>

                <div class="border-t pt-6">
                    <h3 class="font-bold text-sm mb-3">‡∑Ä‡∑í‡∂ö‡∑î‡∂´‡∑î‡∂∏‡∑ä‡∂ö‡∂ª‡∑î ‡∂ú‡∑ê‡∂± ‡∂î‡∂∂‡∑ö ‡∂Ö‡∂Ø‡∑Ñ‡∑É:</h3>
                    <div class="flex gap-2 mb-4">
                        <select id="ratingScore" class="border p-2 rounded-lg text-sm outline-none">
                            <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (‡∂¥‡∂Ç‡∂ö‡∑è‡∂Ø‡∑î‡∂∫‡∑í)</option>
                            <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê (‡∑Ñ‡∑ú‡∂≥‡∂∫‡∑í)</option>
                            <option value="3">‚≠ê‚≠ê‚≠ê (‡∑É‡∑è‡∂∏‡∑è‡∂±‡∑ä‚Äç‡∂∫‡∂∫‡∑í)</option>
                            <option value="2">‚≠ê‚≠ê (‡∂Ö‡∂©‡∑î‡∂∫‡∑í)</option>
                            <option value="1">‚≠ê (‡∂±‡∂ª‡∂ö‡∂∫‡∑í)</option>
                        </select>
                        <button onclick="submitRating()" class="bg-gray-800 text-white px-4 py-2 rounded-lg text-sm font-bold">Rate</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDtOz0AMlrjcN7xfmkFuhQUU8Zl0MfQMSE",
            authDomain: "adds-ink.firebaseapp.com",
            projectId: "adds-ink",
            storageBucket: "adds-ink.firebasestorage.app",
            messagingSenderId: "638657776631",
            appId: "1:638657776631:web:44ffdad33137bfefa57cf2",
            measurementId: "G-Z002TVT7QX"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        const urlParams = new URLSearchParams(window.location.search);
        const adId = urlParams.get('id');
        let currentSellerId = "";

        // 1. ‡∂Ø‡∑ê‡∂±‡∑ä‡∑Ä‡∑ì‡∂∏‡∑ö ‡∂Ø‡∂≠‡∑ä‡∂≠ ‡∂Ω‡∂∂‡∑è‡∂ú‡∑ê‡∂±‡∑ì‡∂∏
        async function loadAdDetails() {
            if (!adId) return;
            
            const doc = await db.collection("posts").doc(adId).get();
            if (doc.exists) {
                const ad = doc.data();
                currentSellerId = ad.userId; // ‡∑Ä‡∑í‡∂ö‡∑î‡∂´‡∑î‡∂∏‡∑ä‡∂ö‡∂ª‡∑î‡∂ú‡∑ö ID ‡∂ë‡∂ö
                
                document.getElementById('adTitle').innerText = ad.title;
                document.getElementById('adPrice').innerText = "‡∂ª‡∑î. " + Number(ad.price).toLocaleString();
                document.getElementById('adLocation').innerText = "üìç " + (ad.district || "‡∑Å‡∑ä‚Äç‡∂ª‡∑ì ‡∂Ω‡∂Ç‡∂ö‡∑è‡∑Ä");
                document.getElementById('adDescription').innerText = ad.description;
                document.getElementById('adImage').src = ad.imageUrl || "https://via.placeholder.com/600x400";
                
                loadSellerData(ad.userId);
            }
        }

        // 2. ‡∑Ä‡∑í‡∂ö‡∑î‡∂´‡∑î‡∂∏‡∑ä‡∂ö‡∂ª‡∑î‡∂ú‡∑ö ‡∂Ø‡∂≠‡∑ä‡∂≠ ‡∑É‡∑Ñ Rating ‡∂Ω‡∂∂‡∑è‡∂ú‡∑ê‡∂±‡∑ì‡∂∏
        function loadSellerData(sellerId) {
            db.collection("users").doc(sellerId).onSnapshot(doc => {
                if (doc.exists) {
                    const seller = doc.data();
                    document.getElementById('sellerName').innerText = seller.name || "‡∑Ä‡∑í‡∂ö‡∑î‡∂´‡∑î‡∂∏‡∑ä‡∂ö‡∂ª‡∑î";
                    document.getElementById('sellerInitial').innerText = (seller.name || "S").charAt(0).toUpperCase();
                    
                    const avg = seller.averageRating || 0;
                    const total = seller.totalRatings || 0;
                    document.getElementById('sellerRating').innerHTML = `‚òÖ ${avg} (${total} reviews)`;
                }
            });
        }

        // 3. Rating ‡∂ë‡∂ö‡∂ö‡∑ä Submit ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏
        async function submitRating() {
            const user = auth.currentUser;
            if (!user) { alert("‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª ‡∂á‡∂≠‡∑î‡∑Ö‡∑î ‡∑Ä‡∂±‡∑ä‡∂± (Login)."); return; }
            if (user.uid === currentSellerId) { alert("‡∂î‡∂∂‡∂ß‡∂∏ Rating ‡∂Ω‡∂∂‡∑è ‡∂Ø‡∑í‡∂∫ ‡∂±‡∑ú‡∑Ñ‡∑ê‡∂ö."); return; }

            const score = document.getElementById('ratingScore').value;
            const sellerRef = db.collection("users").doc(currentSellerId);

            try {
                const sellerDoc = await sellerRef.get();
                const sellerData = sellerDoc.data();
                let ratings = sellerData.ratings || [];
                
                ratings.push({ buyerId: user.uid, score: Number(score) });
                
                const totalScore = ratings.reduce((sum, r) => sum + r.score, 0);
                const avgRating = (totalScore / ratings.length).toFixed(1);

                await sellerRef.update({
                    ratings: ratings,
                    averageRating: Number(avgRating),
                    totalRatings: ratings.length
                });

                alert("‡∑É‡∑ä‡∂≠‡∑ñ‡∂≠‡∑í‡∂∫‡∑í! Rating ‡∂ë‡∂ö ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∑Ä‡∑í‡∂∫.");
            } catch (e) {
                console.error(e);
            }
        }

        // 4. Chat ‡∂ë‡∂ö ‡∑Ä‡∑í‡∑Ä‡∑ò‡∂≠ ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏
        function openChat() {
            const user = auth.currentUser;
            if (!user) { alert("‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª Login ‡∑Ä‡∂±‡∑ä‡∂±."); return; }
            
            // Chat ID ‡∂ë‡∂ö‡∂ö‡∑ä ‡∑É‡∑è‡∂Ø‡∑è chat.html ‡∑Ä‡∑ô‡∂≠ ‡∂∫‡∑ê‡∑Ä‡∑ì‡∂∏
            const chatId = user.uid > currentSellerId ? user.uid + currentSellerId : currentSellerId + user.uid;
            window.location.href = `chat.html?chatId=${chatId}&sellerId=${currentSellerId}`;
        }

        window.onload = loadAdDetails;
    </script>
</body>
</html>
