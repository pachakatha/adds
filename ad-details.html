<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∂Ø‡∑ê‡∂±‡∑ä‡∑Ä‡∑ì‡∂∏‡∑ä ‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª | Adds.ink</title>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">

    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <div class="bg-white rounded-3xl shadow-lg overflow-hidden border border-gray-100">
            
            <div id="adImageContainer" class="h-64 md:h-96 bg-gray-200">
                <img id="adImage" src="" class="w-full h-full object-cover">
            </div>

            <div class="p-6">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h1 id="adTitle" class="text-2xl font-bold text-gray-800">‡∂¥‡∑ñ‡∂ª‡∂´‡∂∫ ‡∑Ä‡∑ô‡∂∏‡∑í‡∂±‡∑ä...</h1>
                        <p id="adLocation" class="text-gray-500 text-sm">üìç ‡∂¥‡∑ñ‡∂ª‡∂´‡∂∫ ‡∑Ä‡∑ô‡∂∏‡∑í‡∂±‡∑ä...</p>
                    </div>
                    <div class="text-right">
                        <p id="adPrice" class="text-2xl font-black text-orange-600">‡∂ª‡∑î. 0</p>
                    </div>
                </div>

                <hr class="my-4 border-gray-100">

                <div class="bg-blue-50 p-4 rounded-2xl flex flex-col md:flex-row items-center justify-between mb-6 border border-blue-100 gap-4">
                    <div class="flex items-center gap-3">
                        <div class="w-14 h-14 bg-blue-600 rounded-full flex items-center justify-center text-white font-bold text-xl shadow-md" id="sellerInitial">S</div>
                        <div>
                            <p class="font-bold text-gray-800 text-lg" id="sellerName">‡∑Ä‡∑í‡∂ö‡∑î‡∂´‡∑î‡∂∏‡∑ä‡∂ö‡∂ª‡∑î</p>
                            <div id="sellerRating" class="flex items-center text-yellow-500 text-sm font-bold">
                                </div>
                        </div>
                    </div>
                    
                    <div class="flex flex-col items-center md:items-end">
                        <p class="text-xs text-gray-500 font-bold uppercase tracking-wider mb-1">‡∑Ä‡∑í‡∂ö‡∑î‡∂´‡∑î‡∂∏‡∑ä‡∂ö‡∂ª‡∑î ‡∂Ö‡∂∏‡∂≠‡∂±‡∑ä‡∂±</p>
                        <a id="phoneBtn" href="#" class="bg-blue-600 text-white px-6 py-3 rounded-2xl font-black text-xl hover:bg-blue-700 transition shadow-lg flex items-center gap-2">
                            üìû <span id="sellerPhone">‡∂¥‡∑ñ‡∂ª‡∂´‡∂∫ ‡∑Ä‡∑ö...</span>
                        </a>
                    </div>
                </div>

                <div class="mb-8">
                    <h3 class="font-bold text-lg mb-2">‡∂Ø‡∑ê‡∂±‡∑ä‡∑Ä‡∑ì‡∂∏‡∑ö ‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª:</h3>
                    <p id="adDescription" class="text-gray-600 leading-relaxed text-sm bg-gray-50 p-4 rounded-xl">‡∂Ø‡∑ê‡∂±‡∑ä‡∑Ä‡∑ì‡∂∏‡∑ö ‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª ‡∂∏‡∑ô‡∑Ñ‡∑í ‡∂Ø‡∑ê‡∂ö‡∑ä‡∑Ä‡∑ö...</p>
                </div>

                <div class="border-t pt-6">
                    <h3 class="font-bold text-sm mb-3">‡∑Ä‡∑í‡∂ö‡∑î‡∂´‡∑î‡∂∏‡∑ä‡∂ö‡∂ª‡∑î ‡∂ú‡∑ê‡∂± ‡∂î‡∂∂‡∑ö ‡∂Ö‡∂Ø‡∑Ñ‡∑É:</h3>
                    <div class="flex flex-wrap gap-2 mb-4">
                        <select id="ratingScore" class="border p-2 rounded-lg text-sm outline-none bg-white">
                            <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (‡∑Ä‡∑í‡∑Å‡∑í‡∑Ç‡∑ä‡∂ß‡∂∫‡∑í)</option>
                            <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê (‡∑Ñ‡∑ú‡∂≥‡∂∫‡∑í)</option>
                            <option value="3">‚≠ê‚≠ê‚≠ê (‡∑É‡∑è‡∂∏‡∑è‡∂±‡∑ä‚Äç‡∂∫‡∂∫‡∑í)</option>
                            <option value="2">‚≠ê‚≠ê (‡∂Ö‡∂©‡∑î‡∂∫‡∑í)</option>
                            <option value="1">‚≠ê (‡∂±‡∂ª‡∂ö‡∂∫‡∑í)</option>
                        </select>
                        <button onclick="submitRating()" class="bg-dark bg-black text-white px-6 py-2 rounded-lg text-sm font-bold hover:bg-gray-800">Rate</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDtOz0AMlrjcN7xfmkFuhQUU8Zl0MfQMSE",
            authDomain: "adds-ink.firebaseapp.com",
            projectId: "adds-ink",
            storageBucket: "adds-ink.firebasestorage.app",
            messagingSenderId: "638657776631",
            appId: "1:638657776631:web:44ffdad33137bfefa57cf2",
            measurementId: "G-Z002TVT7QX"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        const urlParams = new URLSearchParams(window.location.search);
        const adId = urlParams.get('id');
        let currentSellerId = "";

        // 1. ‡∂Ø‡∑ê‡∂±‡∑ä‡∑Ä‡∑ì‡∂∏‡∑ö ‡∂Ø‡∂≠‡∑ä‡∂≠ ‡∂Ω‡∂∂‡∑è‡∂ú‡∑ê‡∂±‡∑ì‡∂∏
        async function loadAdDetails() {
            if (!adId) return;
            
            const doc = await db.collection("posts").doc(adId).get();
            if (doc.exists) {
                const ad = doc.data();
                currentSellerId = ad.userId;
                
                document.getElementById('adTitle').innerText = ad.title;
                document.getElementById('adPrice').innerText = "‡∂ª‡∑î. " + Number(ad.price).toLocaleString();
                document.getElementById('adLocation').innerText = "üìç " + (ad.district || "‡∂Ø‡∑í‡∑É‡∑ä‡∂≠‡∑ä‚Äç‡∂ª‡∑í‡∂ö‡∑ä‡∂ö‡∂∫ ‡∑É‡∂≥‡∑Ñ‡∂±‡∑ä ‡∂ö‡∂ª ‡∂±‡∑ê‡∂≠");
                document.getElementById('adDescription').innerText = ad.description;
                document.getElementById('adImage').src = ad.imageUrl || "https://via.placeholder.com/600x400";
                
                loadSellerData(ad.userId);
            }
        }

        // 2. ‡∑Ä‡∑í‡∂ö‡∑î‡∂´‡∑î‡∂∏‡∑ä‡∂ö‡∂ª‡∑î‡∂ú‡∑ö ‡∂Ø‡∂≠‡∑ä‡∂≠ ‡∑É‡∑Ñ Phone Number ‡∂Ω‡∂∂‡∑è‡∂ú‡∑ê‡∂±‡∑ì‡∂∏
        function loadSellerData(sellerId) {
            db.collection("users").doc(sellerId).onSnapshot(doc => {
                if (doc.exists) {
                    const seller = doc.data();
                    const phone = seller.phone || "‡∂Ö‡∂Ç‡∂ö‡∂∫ ‡∂±‡∑ú‡∂∏‡∑ê‡∂≠";
                    
                    document.getElementById('sellerName').innerText = seller.name || "‡∑Ä‡∑í‡∂ö‡∑î‡∂´‡∑î‡∂∏‡∑ä‡∂ö‡∂ª‡∑î";
                    document.getElementById('sellerInitial').innerText = (seller.name || "S").charAt(0).toUpperCase();
                    document.getElementById('sellerPhone').innerText = phone;
                    
                    // Phone Button ‡∂ë‡∂ö‡∂ß 'tel:' link ‡∂ë‡∂ö ‡∂Ω‡∂∂‡∑è ‡∂Ø‡∑ì‡∂∏ (Click ‡∂ö‡∑Ö ‡∑Ä‡∑í‡∂ß Call ‡∂∫‡∑è‡∂∏‡∂ß)
                    if (seller.phone) {
                        document.getElementById('phoneBtn').href = `tel:${seller.phone}`;
                    }
                    
                    const avg = seller.averageRating || 0;
                    const total = seller.totalRatings || 0;
                    document.getElementById('sellerRating').innerHTML = `‚òÖ ${avg} (${total} reviews)`;
                } else {
                    document.getElementById('sellerPhone').innerText = "‡∂Ö‡∂Ç‡∂ö‡∂∫ ‡∑É‡∑ú‡∂∫‡∑è‡∂ú‡∂≠ ‡∂±‡∑ú‡∑Ñ‡∑ê‡∂ö";
                }
            });
        }

        // 3. Rating ‡∂ë‡∂ö‡∂ö‡∑ä ‡∂Ω‡∂∂‡∑è ‡∂Ø‡∑ì‡∂∏
        async function submitRating() {
            const user = auth.currentUser;
            if (!user) { alert("‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª ‡∂¥‡∑Ö‡∂∏‡∑î‡∑Ä ‡∂á‡∂≠‡∑î‡∑Ö‡∑î ‡∑Ä‡∂±‡∑ä‡∂±."); return; }
            if (user.uid === currentSellerId) { alert("‡∂î‡∂∂‡∂ß‡∂∏ Rating ‡∂Ω‡∂∂‡∑è ‡∂Ø‡∑í‡∂∫ ‡∂±‡∑ú‡∑Ñ‡∑ê‡∂ö."); return; }

            const score = document.getElementById('ratingScore').value;
            const sellerRef = db.collection("users").doc(currentSellerId);

            try {
                const sellerDoc = await sellerRef.get();
                const sellerData = sellerDoc.data();
                let ratings = sellerData.ratings || [];
                
                ratings.push({ buyerId: user.uid, score: Number(score) });
                
                const totalScore = ratings.reduce((sum, r) => sum + r.score, 0);
                const avgRating = (totalScore / ratings.length).toFixed(1);

                await sellerRef.update({
                    ratings: ratings,
                    averageRating: Number(avgRating),
                    totalRatings: ratings.length
                });

                alert("‡∑É‡∑ä‡∂≠‡∑ñ‡∂≠‡∑í‡∂∫‡∑í! ‡∂î‡∂∂‡∑ö ‡∂Ö‡∂Ø‡∑Ñ‡∑É ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∑Ä‡∑í‡∂∫.");
            } catch (e) {
                console.error("Error: ", e);
            }
        }

        window.onload = loadAdDetails;
    </script>
</body>
</html>
