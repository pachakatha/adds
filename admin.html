<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Panel - Lanka Ads</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-gray-100 p-8">

<div class="max-w-6xl mx-auto">
    <!-- Header -->
    <div class="bg-white rounded-2xl shadow-lg p-6 mb-6 flex justify-between items-center">
        <h1 class="text-2xl font-bold text-blue-600">Lanka Ads Admin Panel</h1>
        <div id="adminStatus" class="text-sm"></div>
    </div>

    <!-- Ads Container -->
    <div id="adsContainer" class="space-y-4"></div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { 
        getFirestore, 
        collection, 
        getDocs, 
        doc, 
        updateDoc, 
        deleteDoc, 
        query, 
        orderBy 
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { 
        getAuth, 
        onAuthStateChanged,
        signInWithEmailAndPassword 
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDtOz0AMlrjcN7xfmkFuhQUU8Zl0MfQMSE",
        authDomain: "adds-ink.firebaseapp.com",
        projectId: "adds-ink",
        storageBucket: "adds-ink.firebasestorage.app",
        messagingSenderId: "638657776631",
        appId: "1:638657776631:web:44ffdad33137bfefa57cf2"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // Check login status
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            document.getElementById('adminStatus').innerHTML = `
                <span class="text-green-600 font-bold">
                    <i class="fas fa-circle text-xs mr-1"></i> Logged in as: ${user.email}
                </span>
                <button onclick="logout()" class="ml-4 text-red-600 text-sm">Logout</button>
            `;
            await loadAds();
        } else {
            // Show login form if not logged in
            document.getElementById('adminStatus').innerHTML = `
                <div class="text-red-600">Not logged in</div>
            `;
            showLoginForm();
        }
    });

    // Login form
    function showLoginForm() {
        document.getElementById('adsContainer').innerHTML = `
            <div class="bg-white rounded-2xl shadow-lg p-8 max-w-md mx-auto">
                <h2 class="text-xl font-bold mb-6">Admin Login</h2>
                <input type="email" id="loginEmail" placeholder="Email" class="w-full p-3 border rounded-xl mb-4">
                <input type="password" id="loginPassword" placeholder="Password" class="w-full p-3 border rounded-xl mb-4">
                <button onclick="adminLogin()" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold">
                    Login as Admin
                </button>
            </div>
        `;
    }

    // Admin login function
    window.adminLogin = async () => {
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;
        
        try {
            await signInWithEmailAndPassword(auth, email, password);
            // After login, onAuthStateChanged will trigger loadAds()
        } catch (error) {
            alert("Login failed: " + error.message);
        }
    };

    // Load all ads
    async function loadAds() {
        try {
            const q = query(collection(db, "posts"), orderBy("createdAt", "desc"));
            const snapshot = await getDocs(q);
            
            let html = '';
            
            snapshot.forEach((doc) => {
                const ad = doc.data();
                const isPremium = ad.premiumStatus === "active" || ad.isPremium === true;
                
                html += `
                    <div class="bg-white rounded-2xl shadow-lg p-6">
                        <div class="flex gap-6">
                            <img src="${ad.imageUrl || 'https://via.placeholder.com/100'}" 
                                 class="w-24 h-24 rounded-xl object-cover">
                            
                            <div class="flex-1">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <h3 class="font-bold text-lg">${ad.title || 'No title'}</h3>
                                        <p class="text-gray-600 text-sm">${ad.description?.substring(0, 100)}...</p>
                                        <div class="flex gap-4 mt-2 text-sm">
                                            <span><i class="fas fa-map-marker-alt text-gray-400"></i> ${ad.district || 'N/A'}</span>
                                            <span><i class="fas fa-tag text-gray-400"></i> ${ad.category || 'N/A'}</span>
                                            <span class="font-bold text-blue-600">Rs. ${(ad.price || 0).toLocaleString()}</span>
                                        </div>
                                    </div>
                                    <span class="px-3 py-1 rounded-full text-xs font-bold ${isPremium ? 'bg-yellow-100 text-yellow-800' : 'bg-gray-100 text-gray-800'}">
                                        ${isPremium ? '‚≠ê PREMIUM' : 'NORMAL'}
                                    </span>
                                </div>
                                
                                <div class="flex gap-2 mt-4">
                                    <button onclick="togglePremium('${doc.id}', ${isPremium})" 
                                            class="px-4 py-2 ${isPremium ? 'bg-gray-600' : 'bg-yellow-500'} text-white rounded-lg text-sm font-bold">
                                        ${isPremium ? 'Remove Premium' : 'Make Premium'}
                                    </button>
                                    <button onclick="deleteAd('${doc.id}')" 
                                            class="px-4 py-2 bg-red-500 text-white rounded-lg text-sm font-bold">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                    <button onclick="viewAd('${doc.id}')" 
                                            class="px-4 py-2 bg-blue-500 text-white rounded-lg text-sm font-bold">
                                        <i class="fas fa-eye"></i> View
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            if (html === '') {
                html = '<div class="bg-white rounded-2xl shadow-lg p-12 text-center text-gray-500">No ads found</div>';
            }
            
            document.getElementById('adsContainer').innerHTML = html;
            
        } catch (error) {
            console.error("Error loading ads:", error);
            document.getElementById('adsContainer').innerHTML = `
                <div class="bg-red-50 rounded-2xl shadow-lg p-12 text-center">
                    <i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-4"></i>
                    <h3 class="font-bold text-red-800 mb-2">Error Loading Ads</h3>
                    <p class="text-red-600">${error.message}</p>
                    <p class="text-sm text-gray-600 mt-4">Check Firebase Security Rules</p>
                </div>
            `;
        }
    }

    // Toggle premium status
    window.togglePremium = async (id, currentStatus) => {
        try {
            await updateDoc(doc(db, "posts", id), {
                isPremium: !currentStatus,
                premiumStatus: !currentStatus ? "active" : "none"
            });
            alert("Status updated!");
            loadAds(); // Reload
        } catch (error) {
            alert("Error: " + error.message);
        }
    };

    // Delete ad
    window.deleteAd = async (id) => {
        if (confirm("Are you sure you want to delete this ad?")) {
            try {
                await deleteDoc(doc(db, "posts", id));
                alert("Ad deleted!");
                loadAds(); // Reload
            } catch (error) {
                alert("Error: " + error.message);
            }
        }
    };

    // View ad
    window.viewAd = (id) => {
        window.open(`ad-details.html?id=${id}`, '_blank');
    };

    // Logout
    window.logout = async () => {
        await auth.signOut();
        window.location.reload();
    };
</script>

</body>
</html>