<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Admin Dashboard | LankaAds</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>body { font-family: 'Poppins', sans-serif; }</style>
</head>
<body class="bg-gray-100 flex">

    <div class="min-h-screen w-64 bg-slate-900 text-white p-5 flex flex-col fixed">
        <h1 class="text-2xl font-bold mb-10 text-orange-400 text-center border-b border-slate-700 pb-4">LankaAds Admin</h1>
        <nav class="space-y-4">
            <button onclick="filterAds('all')" class="w-full text-left p-3 rounded-lg bg-slate-800 hover:bg-orange-500 transition">üìã ‡∑É‡∑í‡∂∫‡∂Ω‡∑î‡∂∏ ‡∂Ø‡∑ê‡∂±‡∑ä‡∑Ä‡∑ì‡∂∏‡∑ä</button>
            <button onclick="filterAds('premium')" class="w-full text-left p-3 rounded-lg hover:bg-orange-500 transition">‚≠ê Premium ‡∂â‡∂Ω‡∑ä‡∂Ω‡∑ì‡∂∏‡∑ä</button>
            <button onclick="filterAds('byUser')" class="w-full text-left p-3 rounded-lg hover:bg-orange-500 transition">üë§ ‡∂¥‡∂ª‡∑í‡∑Å‡∑ì‡∂Ω‡∂ö ‡∂Ö‡∂±‡∑î‡∑Ä</button>
        </nav>
    </div>

    <div class="flex-1 ml-64">
        <header class="bg-white shadow p-5 sticky top-0 z-20 flex justify-between items-center">
            <h2 id="currentViewTitle" class="text-xl font-bold text-gray-800">‡∑É‡∑í‡∂∫‡∂Ω‡∑î‡∂∏ ‡∂Ø‡∑ê‡∂±‡∑ä‡∑Ä‡∑ì‡∂∏‡∑ä</h2>
            <div class="flex gap-4 items-center">
                <input type="text" id="userInput" placeholder="User ID ‡∂ë‡∂ö ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±..." class="hidden p-2 border rounded-lg text-sm outline-none focus:border-orange-500">
                <div class="text-xs font-bold text-green-600 bg-green-100 px-3 py-1 rounded-full uppercase">Live Sync</div>
            </div>
        </header>

        <div class="p-8">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white p-6 rounded-2xl shadow-sm border-l-4 border-slate-900">
                    <p class="text-xs text-gray-500 font-bold uppercase tracking-wider">‡∂∏‡∑î‡∑Ö‡∑î ‡∂Ø‡∑ê‡∂±‡∑ä‡∑Ä‡∑ì‡∂∏‡∑ä</p>
                    <p id="totalAds" class="text-3xl font-black text-slate-900">0</p>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-sm border-l-4 border-blue-500">
                    <p class="text-xs text-gray-500 font-bold uppercase tracking-wider">‡∂∏‡∑î‡∑Ö‡∑î ‡∂Ö‡∂∏‡∑î‡∂≠‡∑ä‡∂≠‡∂±‡∑ä</p>
                    <p id="totalVisitors" class="text-3xl font-black text-blue-600">0</p>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-sm border-l-4 border-orange-500">
                    <p class="text-xs text-gray-500 font-bold uppercase tracking-wider">‡∂¥‡∑ä‚Äç‡∂ª‡∑í‡∂∏‡∑í‡∂∫‡∂∏‡∑ä ‡∂â‡∂Ω‡∑ä‡∂Ω‡∑ì‡∂∏‡∑ä</p>
                    <p id="premiumReqCount" class="text-3xl font-black text-orange-500">0</p>
                </div>
            </div>

            <div class="bg-white rounded-3xl shadow-sm overflow-hidden border border-gray-100">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-slate-50 border-b border-gray-100">
                        <tr class="text-gray-600 text-[11px] uppercase font-bold tracking-widest">
                            <th class="p-5">‡∂Ø‡∑ê‡∂±‡∑ä‡∑Ä‡∑ì‡∂∏‡∑ö ‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª</th>
                            <th class="p-5">‡∂¥‡∂ª‡∑í‡∑Å‡∑ì‡∂Ω‡∂ö (Author ID)</th>
                            <th class="p-5">‡∂≠‡∂≠‡∑ä‡∂≠‡∑ä‡∑Ä‡∂∫</th>
                            <th class="p-5 text-center">‡∂ö‡∑ä‚Äç‡∂ª‡∑í‡∂∫‡∑è‡∂ö‡∑è‡∂ª‡∂ö‡∂∏‡∑ä</th>
                        </tr>
                    </thead>
                    <tbody id="adsTableBody" class="divide-y divide-gray-50">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
        import { getFirestore, collection, doc, updateDoc, onSnapshot, deleteDoc, query, where } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDtOz0AMlrjcN7xfmkFuhQUU8Zl0MfQMSE",
            authDomain: "adds-ink.firebaseapp.com",
            projectId: "adds-ink",
            storageBucket: "adds-ink.firebasestorage.app",
            messagingSenderId: "638657776631",
            appId: "1:638657776631:web:44ffdad33137bfefa57cf2",
            measurementId: "G-Z002TVT7QX"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let currentFilter = 'all';

        // --- Functions Exposed to Window for HTML Buttons ---
        window.approveAd = async (id) => {
            await updateDoc(doc(db, "posts", id), { status: "approved" });
            alert("‡∂Ø‡∑ê‡∂±‡∑ä‡∑Ä‡∑ì‡∂∏ ‡∂Ö‡∂±‡∑î‡∂∏‡∂≠ ‡∂ö‡∑Ö‡∑è!");
        };

        window.makePremium = async (id) => {
            await updateDoc(doc(db, "posts", id), { isPremium: true, status: "approved", premiumStatus: "active" });
            alert("‡∂Ø‡∑ê‡∂±‡∑ä‡∑Ä‡∑ì‡∂∏ Premium ‡∂ö‡∑Ö‡∑è!");
        };

        window.deleteAd = async (id) => {
            if(confirm("‡∂∏‡∑ô‡∂∫ ‡∑É‡∂Ø‡∑Ñ‡∂ß‡∂∏ ‡∂∏‡∂ö‡∑è ‡∂Ø‡∑ê‡∂∏‡∑ì‡∂∏‡∂ß ‡∂Ö‡∑Ä‡∑Å‡∑ä‚Äç‡∂∫‡∂Ø?")) {
                await deleteDoc(doc(db, "posts", id));
                alert("‡∂∏‡∂ö‡∑è ‡∂Ø‡∑ê‡∂∏‡∑ì‡∂∏ ‡∑É‡∑è‡∂ª‡∑ä‡∂Æ‡∂ö‡∂∫‡∑í!");
            }
        };

        window.filterAds = (type) => {
            currentFilter = type;
            const input = document.getElementById('userInput');
            const title = document.getElementById('currentViewTitle');
            
            input.classList.add('hidden');
            if(type === 'all') title.innerText = "‡∑É‡∑í‡∂∫‡∂Ω‡∑î‡∂∏ ‡∂Ø‡∑ê‡∂±‡∑ä‡∑Ä‡∑ì‡∂∏‡∑ä";
            if(type === 'premium') title.innerText = "Premium ‡∂â‡∂Ω‡∑ä‡∂Ω‡∑ì‡∂∏‡∑ä ‡∂¥‡∂∏‡∂´‡∑í";
            if(type === 'byUser') {
                title.innerText = "‡∂¥‡∂ª‡∑í‡∑Å‡∑ì‡∂Ω‡∂ö ‡∂Ö‡∂±‡∑î‡∑Ä ‡∑É‡∑ô‡∑Ä‡∑ì‡∂∏";
                input.classList.remove('hidden');
            }
            loadData();
        };

        // --- Real-time Data Loader ---
        function loadData() {
            let q = collection(db, "posts");
            const userIdSearch = document.getElementById('userInput').value;

            if (currentFilter === 'premium') {
                q = query(collection(db, "posts"), where("premiumStatus", "==", "waiting_approval"));
            } else if (currentFilter === 'byUser' && userIdSearch) {
                q = query(collection(db, "posts"), where("authorId", "==", userIdSearch));
            }

            onSnapshot(q, (snapshot) => {
                const tableBody = document.getElementById('adsTableBody');
                tableBody.innerHTML = "";
                
                snapshot.forEach((doc) => {
                    const ad = doc.data();
                    const id = doc.id;

                    tableBody.innerHTML += `
                        <tr class="hover:bg-orange-50/30 transition">
                            <td class="p-5">
                                <div class="font-bold text-slate-800 text-sm">${ad.title}</div>
                                <div class="text-[10px] text-gray-400 uppercase mt-1">${ad.category} | ${ad.district}</div>
                            </td>
                            <td class="p-5 font-mono text-[10px] text-gray-500">${ad.authorId}</td>
                            <td class="p-5">
                                <span class="px-2 py-1 rounded text-[9px] font-black ${ad.isPremium ? 'bg-amber-100 text-amber-600' : 'bg-slate-100 text-slate-500'}">
                                    ${ad.isPremium ? 'PREMIUM' : 'NORMAL'}
                                </span>
                            </td>
                            <td class="p-5 flex gap-2 justify-center">
                                <button onclick="approveAd('${id}')" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-[10px] font-bold shadow-sm transition">Approve</button>
                                <button onclick="makePremium('${id}')" class="bg-amber-500 hover:bg-amber-600 text-white px-3 py-1 rounded text-[10px] font-bold shadow-sm transition">‚≠ê Premium</button>
                                <button onclick="deleteAd('${id}')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-[10px] font-bold shadow-sm transition">Delete</button>
                            </td>
                        </tr>
                    `;
                });
            });
        }

        // Stats & Initialization
        onSnapshot(collection(db, "posts"), (snap) => {
            document.getElementById('totalAds').innerText = snap.size;
            let pCount = 0;
            snap.forEach(d => { if(d.data().premiumStatus === 'waiting_approval') pCount++; });
            document.getElementById('premiumReqCount').innerText = pCount;
        });

        onSnapshot(doc(db, "analytics", "siteStats"), (d) => {
            if(d.exists()) document.getElementById('totalVisitors').innerText = d.data().totalVisitors;
        });

        document.getElementById('userInput').addEventListener('input', loadData);
        loadData();

    </script>
</body>
</html>
