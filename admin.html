<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lanka Ads Admin - ඇඩ්මින් පැනලය</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --primary: #007bff; --danger: #ff4d4d; --success: #2ecc71; --gold: #f1c40f; }
        body { font-family: 'Inter', sans-serif; background: #f0f2f5; margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: auto; }
        
        .header { background: white; padding: 20px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .header h2 { margin: 0; color: var(--primary); }

        .ad-row { background: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; display: grid; grid-template-columns: 80px 1fr auto; gap: 20px; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .ad-img { width: 80px; height: 80px; border-radius: 8px; object-fit: cover; }
        
        .ad-info h3 { margin: 0 0 5px 0; font-size: 16px; }
        .ad-info p { margin: 0; font-size: 14px; color: #666; }
        .price { color: var(--primary); font-weight: 700; margin-top: 5px; }

        .badge { display: inline-block; padding: 3px 8px; border-radius: 5px; font-size: 10px; font-weight: 800; margin-bottom: 5px; }
        .premium-badge { background: var(--gold); color: black; }
        .normal-badge { background: #eee; color: #666; }

        .actions { display: flex; gap: 10px; }
        .btn { border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: 0.3s; }
        .btn-premium { background: var(--gold); color: black; }
        .btn-normal { background: #6c757d; color: white; }
        .btn-delete { background: var(--danger); color: white; }
        .btn:hover { opacity: 0.8; }

        #loader { text-align: center; padding: 50px; font-weight: bold; color: #888; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h2>Lanka Ads Admin</h2>
        <div id="admin-status" style="font-size: 12px; color: #555;">සම්බන්ධ වෙමින්...</div>
    </div>

    <div id="loader">දත්ත පූරණය වෙමින් පවතී...</div>
    <div id="ads-list"></div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, updateDoc, deleteDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // ඔබේ Config එක
    const firebaseConfig = {
        apiKey: "AIzaSyDtOz0AMlrjcN7xfmkFuhQUU8Zl0MfQMSE",
        authDomain: "adds-ink.firebaseapp.com",
        projectId: "adds-ink",
        storageBucket: "adds-ink.firebasestorage.app",
        messagingSenderId: "638657776631",
        appId: "1:638657776631:web:44ffdad33137bfefa57cf2",
        measurementId: "G-Z002TVT7QX"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // Auth Check
    onAuthStateChanged(auth, (user) => {
        if (user) {
            document.getElementById('admin-status').innerHTML = `<i class="fas fa-circle" style="color:green"></i> Admin Active`;
            loadAds();
        } else {
            document.getElementById('admin-status').innerHTML = `<i class="fas fa-circle" style="color:red"></i> Offline (Please Login)`;
            // මෙහිදී ඔබගේ සාමාන්‍ය Login පිටුවට යොමු කළ හැක
        }
    });

    async function loadAds() {
        const adsList = document.getElementById('ads-list');
        const loader = document.getElementById('loader');
        
        try {
            // "posts" collection එකෙන් දත්ත ගනියි
            const q = query(collection(db, "posts"), orderBy("createdAt", "desc"));
            const snapshot = await getDocs(q);
            
            adsList.innerHTML = "";
            loader.style.display = "none";

            snapshot.forEach((adDoc) => {
                const ad = adDoc.data();
                const id = adDoc.id;
                const isPremium = ad.isPremium === true || ad.isFeatured === true;

                const adEl = document.createElement('div');
                adEl.className = 'ad-row';
                adEl.innerHTML = `
                    <img src="${ad.imageUrl || 'https://via.placeholder.com/80'}" class="ad-img">
                    <div class="ad-info">
                        <span class="badge ${isPremium ? 'premium-badge' : 'normal-badge'}">
                            ${isPremium ? 'PREMIUM AD' : 'NORMAL AD'}
                        </span>
                        <h3>${ad.title}</h3>
                        <p>${ad.district || 'Lanka'} | ${ad.category || 'General'}</p>
                        <div class="price">Rs. ${parseFloat(ad.price).toLocaleString()}</div>
                    </div>
                    <div class="actions">
                        <button class="btn ${isPremium ? 'btn-normal' : 'btn-premium'}" onclick="togglePremium('${id}', ${isPremium})">
                            ${isPremium ? 'Demote' : 'Make Premium'}
                        </button>
                        <button class="btn btn-delete" onclick="deletePost('${id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                adsList.appendChild(adEl);
            });
        } catch (err) {
            loader.innerHTML = "දත්ත ලබා ගැනීමේ දෝෂයකි. (Rules පරීක්ෂා කරන්න)";
            console.error(err);
        }
    }

    // --- ක්‍රියාකාරකම් ---

    window.togglePremium = async (id, currentStatus) => {
        const adRef = doc(db, "posts", id);
        try {
            await updateDoc(adRef, {
                isPremium: !currentStatus,
                isFeatured: !currentStatus
            });
            alert("සාර්ථකව යාවත්කාලීන විය!");
            loadAds();
        } catch (e) {
            alert("Error: " + e.message);
        }
    };

    window.deletePost = async (id) => {
        if (confirm("මෙම දැන්වීම ස්ථිරවම මකා දමන්නද?")) {
            try {
                await deleteDoc(doc(db, "posts", id));
                alert("මකා දමන ලදී!");
                loadAds();
            } catch (e) {
                alert("Error: " + e.message);
            }
        }
    };

</script>
</body>
</html>
