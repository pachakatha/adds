<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lanka Ads - Buy & Sell</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --primary: #007bff; --premium-red: #ff4d4d; --dark: #2d3436; }
        body { font-family: 'Inter', sans-serif; margin: 0; background-color: #f0f2f5; }
        nav { background: white; padding: 12px 6%; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 1000; }
        .logo { font-size: 28px; font-weight: 800; color: var(--primary); text-decoration: none; }
        .ads-section { padding: 40px 6%; }
        .ads-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 25px; }
        
        /* Ad Card Styling */
        .ad-card { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.08); cursor: pointer; transition: 0.3s; text-decoration: none; color: inherit; display: block; }
        .ad-card:hover { transform: translateY(-5px); }
        .ad-card img { width: 100%; height: 180px; object-fit: cover; background: #eee; }
        .ad-content { padding: 15px; }
        .ad-price { color: var(--primary); font-size: 20px; font-weight: 800; margin: 8px 0; }
        .ad-title { font-weight: 600; font-size: 16px; margin-bottom: 5px; }
        .loading-text { text-align: center; grid-column: 1/-1; padding: 40px; }
        .btn-post { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; background: #28a745; color: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); text-decoration: none; }
    </style>
</head>
<body>

    <nav>
        <a href="index.html" class="logo">Lanka Ads</a>
        <div id="auth-box">
            <a href="post-ad.html" style="text-decoration:none; font-weight:700; color:var(--primary);">Post Your Ad</a>
        </div>
    </nav>

    <div class="ads-section">
        <h2 style="margin-bottom:20px;">Latest Ads</h2>
        <div class="ads-grid" id="ads-grid">
            <div class="loading-text">Fetching ads...</div>
        </div>
    </div>

    <a href="post-ad.html" class="btn-post"><i class="fas fa-plus"></i></a>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDtOz0AMlrjcN7xfmkFuhQUU8Zl0MfQMSE",
            authDomain: "adds-ink.firebaseapp.com",
            projectId: "adds-ink",
            storageBucket: "adds-ink.firebasestorage.app",
            messagingSenderId: "638657776631",
            appId: "1:638657776631:web:44ffdad33137bfefa57cf2"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // üõë Google Drive Photo Fix üõë
        function convertDriveLink(url) {
            if (url && url.includes('drive.google.com')) {
                let id = "";
                if (url.includes('/d/')) {
                    id = url.split('/d/')[1].split('/')[0];
                } else if (url.includes('id=')) {
                    id = url.split('id=')[1].split('&')[0];
                }
                return id ? `https://drive.google.com/uc?export=view&id=${id}` : url;
            }
            return url;
        }

        async function fetchAds() {
            const adsGrid = document.getElementById('ads-grid');
            try {
                const q = query(collection(db, "posts"), orderBy("createdAt", "desc"));
                const querySnapshot = await getDocs(q);
                let html = "";

                querySnapshot.forEach((doc) => {
                    const ad = doc.data();
                    const adId = doc.id; // Document ID ‡∂ë‡∂ö ‡∂ú‡∂±‡∑ä‡∂±‡∑Ä‡∑è details ‡∂∂‡∂Ω‡∂±‡∑ä‡∂±
                    const imageUrl = convertDriveLink(ad.imageUrl);

                    html += `
                        <a href="ad-details.html?id=${adId}" class="ad-card">
                            <img src="${imageUrl}" onerror="this.src='https://via.placeholder.com/300?text=No+Image'">
                            <div class="ad-content">
                                <div class="ad-title">${ad.title}</div>
                                <div class="ad-price">Rs. ${parseFloat(ad.price).toLocaleString()}</div>
                                <div style="font-size:12px; color:#666;"><i class="fas fa-map-marker-alt"></i> ${ad.district}</div>
                            </div>
                        </a>
                    `;
                });

                adsGrid.innerHTML = html || '<div class="loading-text">No ads found.</div>';
            } catch (error) {
                console.error(error);
                adsGrid.innerHTML = '<div class="loading-text">Error loading ads. Check Console.</div>';
            }
        }

        fetchAds();
    </script>
</body>
</html>
