<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>අලුත් දැන්වීමක් පළ කරන්න | Lanka Ads</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-gray-100">

    <div class="max-w-xl mx-auto my-10 p-6 bg-white rounded-xl shadow-lg">
        <h2 id="page-title" class="text-2xl font-bold text-center mb-6 text-blue-600">අලුත් දැන්වීමක් පළ කරන්න</h2>

        <form id="postForm" class="space-y-4">
            <div>
                <label class="block font-semibold mb-1">දැන්වීමේ මාතෘකාව (Title)</label>
                <input type="text" id="title" class="w-full p-3 border rounded-lg outline-none focus:border-blue-500" placeholder="උදා: iPhone 13 for sale" required>
            </div>

            <div>
                <label class="block font-semibold mb-1">විස්තරය (Description)</label>
                <textarea id="description" rows="4" class="w-full p-3 border rounded-lg outline-none focus:border-blue-500" placeholder="ඔබේ භාණ්ඩය හෝ සේවාව ගැන විස්තර ලියන්න..." required></textarea>
            </div>

            <div>
                <label class="block font-semibold mb-1">මිල (Price - Rs.)</label>
                <input type="number" id="price" class="w-full p-3 border rounded-lg outline-none focus:border-blue-500" placeholder="5000" required>
            </div>

            <div>
                <label class="block font-semibold mb-1">දිස්ත්‍රික්කය</label>
                <select id="district" class="w-full p-3 border rounded-lg outline-none focus:border-blue-500">
                    <option value="Colombo">Colombo</option>
                    <option value="Gampaha">Gampaha</option>
                    <option value="Kandy">Kandy</option>
                    <option value="Kalutara">Kalutara</option>
                    <option value="Galle">Galle</option>
                    <option value="Matara">Matara</option>
                    <option value="Jaffna">Jaffna</option>
                    <option value="Kurunegala">Kurunegala</option>
                    <option value="Anuradhapura">Anuradhapura</option>
                </select>
            </div>

            <div>
                <label class="block font-semibold mb-1">භාණ්ඩයේ පින්තූරයක් එක් කරන්න</label>
                <input type="file" id="imageFile" accept="image/*" class="w-full p-2 border border-dashed rounded-lg" required>
            </div>

            <button type="submit" id="submitBtn" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition">
                දැන්වීම පළ කරන්න
            </button>
        </form>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        // ඔබේ Firebase Config එක මෙතනට දාන්න
        const firebaseConfig = {
            apiKey: "AIzaSyDtOz0AMlrjcN7xfmkFuhQUU8Zl0MfQMSE",
            authDomain: "adds-ink.firebaseapp.com",
            projectId: "adds-ink",
            storageBucket: "adds-ink.firebasestorage.app",
            messagingSenderId: "638657776631",
            appId: "1:638657776631:web:44ffdad33137bfefa57cf2"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        const postForm = document.getElementById('postForm');
        
        postForm.onsubmit = async (e) => {
            e.preventDefault();
            const user = auth.currentUser;
            
            if(!user) {
                alert("කරුණාකර දැන්වීමක් පළ කිරීමට පෙර ලොග් වන්න!");
                return window.location.href = "login.html";
            }

            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.innerText = "පළ කරමින් පවතී...";

            try {
                let imageUrl = "";
                const file = document.getElementById('imageFile').files[0];
                
                // Image Upload logic
                if(file) {
                    const storageRef = ref(storage, `posts/${Date.now()}_${file.name}`);
                    const snapshot = await uploadBytes(storageRef, file);
                    imageUrl = await getDownloadURL(snapshot.ref);
                }

                // Firestore වෙත දත්ත යැවීම
                await addDoc(collection(db, "posts"), {
                    title: document.getElementById('title').value,
                    description: document.getElementById('description').value,
                    price: parseFloat(document.getElementById('price').value),
                    district: document.getElementById('district').value,
                    imageUrl: imageUrl,
                    postType: "ad", // සියල්ල දැන්වීම් ලෙස සේව් වේ
                    authorId: user.uid,
                    authorName: user.displayName || "පරිශීලක",
                    authorImg: user.photoURL || "",
                    createdAt: serverTimestamp(),
                    premiumStatus: "none"
                });

                alert("දැන්වීම සාර්ථකව පළ කරන ලදී!");
                window.location.href = "index.html";

            } catch (err) {
                console.error(err);
                alert("දෝෂයකි: " + err.message);
                submitBtn.disabled = false;
                submitBtn.innerText = "දැන්වීම පළ කරන්න";
            }
        };
    </script>
</body>
</html>
