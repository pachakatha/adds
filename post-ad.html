<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>දැන්වීමක් පළ කරන්න | Lanka Ads</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .input-box { @apply w-full p-3 border border-gray-300 rounded-lg outline-none focus:border-orange-500 focus:ring-1 focus:ring-orange-500; }
        .label-style { @apply block font-semibold mb-1 text-gray-700; }
        .orange-theme { border-color: #f97316; }
    </style>
</head>
<body class="bg-gray-100">

    <div class="max-w-2xl mx-auto my-10 p-6 bg-white rounded-2xl shadow-lg border-t-8 border-orange-500">
        <h2 class="text-3xl font-bold text-center mb-8 text-gray-800">
            <i class="fas fa-plus-circle text-orange-600 mr-2"></i>නව දැන්වීමක් පළ කරන්න
        </h2>

        <form id="postForm" class="space-y-5">
            
            <div>
                <label class="label-style">1. භාණ්ඩයේ නම (Title)</label>
                <input type="text" id="title" class="input-box" placeholder="උදා: Toyota Corolla 2020" required>
            </div>

            <div>
                <label class="label-style">2. භාණ්ඩයේ විස්තර (Description)</label>
                <textarea id="description" rows="4" class="input-box" placeholder="භාණ්ඩය ගැන සම්පූර්ණ විස්තරයක් ලියන්න..." required></textarea>
            </div>

            <div>
                <label class="label-style">3. ප්‍රවර්ගය (Category)</label>
                <select id="category" class="input-box" required>
                    <option value="">කැටගරි එකක් තෝරන්න</option>
                    <option value="Vehicles">Vehicles (වාහන)</option>
                    <option value="Electronics">Electronics (විදුලි උපකරණ)</option>
                    <option value="Property">Property (ඉඩම් සහ නිවාස)</option>
                    <option value="Home & Garden">Home & Garden</option>
                    <option value="Fashion & Beauty">Fashion & Beauty</option>
                    <option value="Services">Services (සේවා)</option>
                    <option value="Business & Industry">Business & Industry</option>
                    <option value="Education">Education (අධ්‍යාපන)</option>
                    <option value="Pets">Pets (සතුන්)</option>
                    <option value="Food & Agriculture">Food & Agriculture</option>
                    <option value="Other">Other</option>
                </select>
            </div>

            <div>
                <label class="label-style">4. දිස්ත්‍රික්කය (District)</label>
                <select id="district" class="input-box" required>
                    <option value="">දිස්ත්‍රික්කයක් තෝරන්න</option>
                    <option value="Ampara">Ampara</option><option value="Anuradhapura">Anuradhapura</option><option value="Badulla">Badulla</option><option value="Batticaloa">Batticaloa</option><option value="Colombo">Colombo</option><option value="Galle">Galle</option><option value="Gampaha">Gampaha</option><option value="Hambantota">Hambantota</option><option value="Jaffna">Jaffna</option><option value="Kalutara">Kalutara</option><option value="Kandy">Kandy</option><option value="Kegalle">Kegalle</option><option value="Kilinochchi">Kilinochchi</option><option value="Kurunegala">Kurunegala</option><option value="Mannar">Mannar</option><option value="Matale">Matale</option><option value="Matara">Matara</option><option value="Moneragala">Moneragala</option><option value="Mullaitivu">Mullaitivu</option><option value="Nuwara Eliya">Nuwara Eliya</option><option value="Polonnaruwa">Polonnaruwa</option><option value="Puttalam">Puttalam</option><option value="Ratnapura">Ratnapura</option><option value="Trincomalee">Trincomalee</option><option value="Vavuniya">Vavuniya</option>
                </select>
            </div>

            <div class="border-2 border-blue-300 rounded-xl p-5 bg-blue-50">
                <p class="font-bold text-blue-900 mb-2 text-center">පින්තූරය Google Drive හරහා එක් කරන්න</p>
                <p class="text-xs text-blue-700 mb-3 text-center">
                    ගූගල් ඩ්‍රයිව් ලින්ක් එක ලබාගන්නා හැටි: <br>
                    <a href="https://youtube.com/shorts/xs-amsA8m0E" target="_blank" class="text-blue-600 underline font-bold">මෙහි ඇති වීඩියෝව බලන්න</a>
                </p>
                <input type="text" id="imageUrl" class="input-box border-blue-300" placeholder="https://drive.google.com/open?id=...">
                <p class="text-[10px] text-blue-500 mt-2 italic text-center text-red-500">වැදගත්: ලින්ක් එක "Anyone with the link" ලෙස සකසා තිබිය යුතුය.</p>
            </div>

            <div>
                <label class="label-style">5. භාණ්ඩයේ මිල (Price - Rs.)</label>
                <input type="number" id="price" class="input-box" placeholder="උදා: 5000" required>
            </div>

            <div>
                <label class="label-style">6. දුරකථන අංකය (Country Code සමග)</label>
                <input type="tel" id="phone" class="input-box" placeholder="+94XXXXXXXXX" required>
            </div>

            <div>
                <label class="label-style">7. WhatsApp අංකය (Country Code සමග)</label>
                <input type="tel" id="whatsapp" class="input-box" placeholder="+94XXXXXXXXX" required>
            </div>

            <div class="border-4 border-amber-400 p-4 rounded-xl flex items-center justify-between bg-gradient-to-r from-red-600 to-amber-500 text-white shadow-md">
                <div>
                    <h4 class="font-bold text-xl uppercase italic">Premium Boost</h4>
                    <p class="text-xs">ඔබේ දැන්වීම ඉහළින්ම පෙන්වීමට මෙය තෝරන්න.</p>
                </div>
                <input type="checkbox" id="premiumCheck" class="w-8 h-8 cursor-pointer accent-orange-500">
            </div>

            <button type="submit" id="submitBtn" class="w-full bg-orange-600 text-white font-bold py-4 rounded-lg hover:bg-orange-700 transition duration-300 text-xl shadow-lg">
                දැන්වීම පළ කරන්න
            </button>
        </form>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDtOz0AMlrjcN7xfmkFuhQUU8Zl0MfQMSE",
            authDomain: "adds-ink.firebaseapp.com",
            projectId: "adds-ink",
            storageBucket: "adds-ink.firebasestorage.app",
            messagingSenderId: "638657776631",
            appId: "1:638657776631:web:44ffdad33137bfefa57cf2"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const postForm = document.getElementById('postForm');
        
        postForm.onsubmit = async (e) => {
            e.preventDefault();
            const user = auth.currentUser;
            
            if(!user) {
                alert("කරුණාකර දැන්වීමක් පළ කිරීමට පෙර ලොග් වන්න!");
                return window.location.href = "login.html";
            }

            const submitBtn = document.getElementById('submitBtn');
            const isPremium = document.getElementById('premiumCheck').checked;
            const driveLink = document.getElementById('imageUrl').value;
            
            submitBtn.disabled = true;
            submitBtn.innerText = "දැන්වීම පළ කරමින්...";

            try {
                // වීඩියෝවේ ඇති පරිදි Drive Link එක Direct Image Link එකක් බවට පත් කිරීම
                let finalImageUrl = driveLink;
                if (driveLink.includes("drive.google.com")) {
                    // මෙය වීඩියෝවේ පියවරයි
                    finalImageUrl = driveLink.replace("file/d/", "uc?export=view&id=").replace("/view?usp=sharing", "");
                    if(finalImageUrl.includes("open?id=")) {
                        finalImageUrl = finalImageUrl.replace("open?id=", "uc?export=view&id=");
                    }
                }

                const docRef = await addDoc(collection(db, "posts"), {
                    title: document.getElementById('title').value,
                    description: document.getElementById('description').value,
                    category: document.getElementById('category').value,
                    district: document.getElementById('district').value,
                    imageUrl: finalImageUrl,
                    price: parseFloat(document.getElementById('price').value),
                    phone: document.getElementById('phone').value,
                    whatsapp: document.getElementById('whatsapp').value,
                    postType: "ad",
                    authorId: user.uid,
                    authorName: user.displayName || "පරිශීලක",
                    createdAt: serverTimestamp(),
                    status: "pending", 
                    premiumStatus: isPremium ? "pending" : "none"
                });

                alert("දැන්වීම සාර්ථකව පළ කරන ලදී!");
                
                if(isPremium) {
                    window.location.href = `payment.html?adId=${docRef.id}`;
                } else {
                    window.location.href = "index.html";
                }

            } catch (err) {
                alert("දෝෂයකි: " + err.message);
                submitBtn.disabled = false;
                submitBtn.innerText = "දැන්වීම පළ කරන්න";
            }
        };
    </script>
</body>
</html>
