<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile | LankaAds</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Poppins', 'sans-serif'] },
                    colors: { primary: '#FF6B35', secondary: '#004E89', background: '#F7F9FC' }
                }
            }
        }
    </script>
</head>
<body class="bg-background font-sans text-gray-800">

    <nav class="bg-white shadow-sm px-6 py-4 flex justify-between items-center sticky top-0 z-50">
        <a href="index.html" class="text-2xl font-bold text-secondary flex items-center gap-2">
            <span class="bg-primary text-white p-2 rounded-lg">LA</span> LankaAds
        </a>
        <button onclick="logout()" class="text-red-500 font-semibold text-sm">Logout</button>
    </nav>

    <div class="container mx-auto px-4 py-8 max-w-5xl">
        
        <div class="bg-white rounded-3xl p-8 shadow-xl mb-8 border border-gray-100 flex flex-col md:flex-row justify-between items-center gap-6">
            <div class="flex items-center gap-4">
                <div class="w-20 h-20 bg-secondary text-white rounded-full flex items-center justify-center text-3xl font-bold">
                    <span id="user-initial">U</span>
                </div>
                <div>
                    <h2 id="user-email" class="text-2xl font-bold text-secondary">Loading...</h2>
                    <p id="user-id" class="text-xs text-gray-400">UID: ...</p>
                </div>
            </div>
            
            <div class="text-center bg-slate-50 p-4 rounded-2xl w-full md:w-auto">
                <p class="text-xs text-gray-500">Profile Completeness</p>
                <div class="text-3xl font-bold text-primary" id="completion-percentage">0%</div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
            
            <div class="md:col-span-2 bg-white rounded-3xl p-8 shadow-xl border border-gray-100">
                <h3 class="text-xl font-bold text-secondary mb-6">üë§ ‡∂¥‡∑î‡∂Ø‡∑ä‡∂ú‡∂Ω‡∑í‡∂ö ‡∂≠‡∑ú‡∂ª‡∂≠‡∑î‡∂ª‡∑î (Personal Info)</h3>
                
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <input type="text" id="fullname" placeholder="‡∑É‡∂∏‡∑ä‡∂¥‡∑ñ‡∂ª‡∑ä‡∂´ ‡∂±‡∂∏" class="p-4 rounded-xl border border-gray-200">
                    <input type="date" id="dob" class="p-4 rounded-xl border border-gray-200 text-gray-500">
                    <input type="text" id="province" placeholder="‡∂¥‡∑Ö‡∑è‡∂≠" class="p-4 rounded-xl border border-gray-200">
                    <input type="text" id="district" placeholder="‡∂Ø‡∑í‡∑É‡∑ä‡∂≠‡∑ä‚Äç‡∂ª‡∑í‡∂ö‡∑ä‡∂ö‡∂∫" class="p-4 rounded-xl border border-gray-200">
                    <textarea id="address" placeholder="‡∂Ω‡∑í‡∂¥‡∑í‡∂±‡∂∫" class="col-span-full p-4 rounded-xl border border-gray-200" rows="2"></textarea>
                </div>
                <button onclick="saveProfile()" class="mt-6 bg-secondary text-white w-full py-4 rounded-xl font-bold hover:bg-blue-900 transition">‡∂≠‡∑ú‡∂ª‡∂≠‡∑î‡∂ª‡∑î ‡∑É‡∑î‡∂ª‡∂ö‡∑í‡∂±‡∑ä‡∂± (Save)</button>
            </div>

            <div class="bg-white rounded-3xl p-8 shadow-xl border border-gray-100">
                <h3 class="text-xl font-bold text-secondary mb-6">üîí ‡∂≠‡∑Ñ‡∑Ä‡∑î‡∂ª‡∑î ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∑ä (Verification)</h3>
                
                <div class="mb-6">
                    <p class="text-sm font-semibold">Email Verification</p>
                    <p id="email-status" class="text-xs text-gray-500 mb-2">Checking...</p>
                    <button id="verify-email-btn" onclick="sendVerification()" class="hidden text-xs bg-primary text-white px-4 py-2 rounded-lg font-bold">Verify Email</button>
                    <p class="text-[10px] text-gray-400 mt-1">Verification mail ‡∂ë‡∂ö spam folder ‡∂ë‡∂ö‡∑ö ‡∂≠‡∑í‡∂∂‡∑í‡∂∫ ‡∑Ñ‡∑ê‡∂ö.</p>
                </div>

                <div>
                    <p class="text-sm font-semibold">Phone Verification</p>
                    <div id="phone-content">
                        <p id="phone-status" class="text-xs text-gray-500 mb-2">Phone Not Verified</p>
                        <input type="tel" id="phoneNumber" placeholder="+947XXXXXXXX" class="w-full p-3 rounded-lg border border-gray-200 text-sm mb-2">
                        <div id="recaptcha-container"></div>
                        <button onclick="sendOTP()" class="text-xs bg-secondary text-white px-4 py-2 rounded-lg font-bold">Send OTP</button>
                    </div>
                </div>
            </div>
        </div>
        
        <h3 class="text-xl font-bold text-secondary mt-12 mb-6">üìã ‡∂∏‡∂ú‡∑ö ‡∂Ø‡∑ê‡∂±‡∑ä‡∑Ä‡∑ì‡∂∏‡∑ä</h3>
        <div id="my-ads-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
            <p class="col-span-full text-center text-gray-400 py-10">‡∂Ø‡∑ê‡∂±‡∑ä‡∑Ä‡∑ì‡∂∏‡∑ä ‡∂¥‡∑ñ‡∂ª‡∂´‡∂∫ ‡∑Ä‡∑ô‡∂∏‡∑í‡∂±‡∑ä ‡∂¥‡∑Ä‡∂≠‡∑ì...</p>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBvTTRbiSEyuYi7XCM5_tHvjaZzaFN_8IQ",
            authDomain: "add-ink.firebaseapp.com",
            projectId: "add-ink",
            storageBucket: "add-ink.firebasestorage.app",
            messagingSenderId: "752189116425",
            appId: "1:752189116425:web:0acf6e7b3f6b3629e3e8d8"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let currentUser;

        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                document.getElementById('user-email').innerText = user.email;
                document.getElementById('user-id').innerText = "UID: " + user.uid;
                document.getElementById('user-initial').innerText = user.email.charAt(0).toUpperCase();
                
                checkEmailStatus(user);
                checkPhoneStatus(user);
                loadProfileData(user.uid);
                loadMyAds(user.uid);
            } else {
                window.location.href = "login.html";
            }
        });

        // 1. Email Status
        function checkEmailStatus(user) {
            const status = document.getElementById('email-status');
            const btn = document.getElementById('verify-email-btn');
            if (user.emailVerified) {
                status.innerText = "‚úÖ Email Verified";
                status.className = "text-xs text-green-600 mb-2 font-bold";
            } else {
                status.innerText = "‚ùå Email Unverified";
                status.className = "text-xs text-red-600 mb-2 font-bold";
                btn.classList.remove('hidden');
            }
        }

        function sendVerification() {
            auth.currentUser.sendEmailVerification().then(() => {
                alert("Verification link ‡∂ë‡∂ö email ‡∂ë‡∂ö‡∂ß ‡∂∫‡∑Ä‡∂± ‡∂Ω‡∂Ø‡∑ì. ‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª Inbox ‡∑É‡∑Ñ Spam folder ‡∂¥‡∂ª‡∑ì‡∂ö‡∑ä‡∑Ç‡∑è ‡∂ö‡∂ª‡∂±‡∑ä‡∂±.");
            }).catch(err => alert("Error: " + err.message));
        }

        // 2. Phone Status
        function checkPhoneStatus(user) {
            const status = document.getElementById('phone-status');
            const phoneProvider = user.providerData.find(p => p.providerId === 'phone');
            if (phoneProvider) {
                status.innerText = "‚úÖ Verified: " + phoneProvider.phoneNumber;
                status.className = "text-xs text-green-600 mb-2 font-bold";
                document.getElementById('phone-content').classList.add('hidden');
            }
        }

        // 3. Save & Load Profile Data
        async function saveProfile() {
            const data = {
                fullname: document.getElementById('fullname').value,
                dob: document.getElementById('dob').value,
                province: document.getElementById('province').value,
                district: document.getElementById('district').value,
                address: document.getElementById('address').value,
            };
            await db.collection("users").doc(currentUser.uid).set(data, { merge: true });
            alert("‡∂≠‡∑ú‡∂ª‡∂≠‡∑î‡∂ª‡∑î ‡∑É‡∑î‡∂ª‡∂ö‡∑í‡∂± ‡∂Ω‡∂Ø‡∑ì!");
            location.reload();
        }

        async function loadProfileData(uid) {
            const doc = await db.collection("users").doc(uid).get();
            if (doc.exists) {
                const data = doc.data();
                document.getElementById('fullname').value = data.fullname || '';
                document.getElementById('dob').value = data.dob || '';
                document.getElementById('province').value = data.province || '';
                document.getElementById('district').value = data.district || '';
                document.getElementById('address').value = data.address || '';
                calculateCompletion(data, currentUser);
            }
        }

        // 4. Completion Percentage
        function calculateCompletion(data, user) {
            let fields = ['fullname', 'dob', 'province', 'district', 'address'];
            let filled = 0;
            fields.forEach(f => { if(data[f]) filled++; });
            
            let percentage = Math.round((filled / fields.length) * 100);
            document.getElementById('completion-percentage').innerText = percentage + "%";
        }

        // Phone Auth Logic
        function sendOTP() {
            const number = document.getElementById('phoneNumber').value;
            window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {'size': 'invisible'});
            auth.currentUser.linkWithPhoneNumber(number, window.recaptchaVerifier)
                .then((result) => {
                    let code = prompt("Enter the 6-digit OTP");
                    if (code) {
                        result.confirm(code).then(() => {
                            alert("Phone Verified!");
                            location.reload();
                        }).catch(err => alert("Wrong OTP"));
                    }
                }).catch(err => alert("Error: " + err.message));
        }

        // Ads Logic
        async function loadMyAds(uid) {
            const grid = document.getElementById('my-ads-grid');
            const snapshot = await db.collection("posts").where("userId", "==", uid).get();
            grid.innerHTML = "";
            if (snapshot.empty) {
                grid.innerHTML = "<p class='col-span-full text-center text-gray-500'>‡∂Ø‡∑ê‡∂±‡∑ä‡∑Ä‡∑ì‡∂∏‡∑ä ‡∂±‡∑ê‡∂≠.</p>";
                return;
            }
            snapshot.forEach(doc => {
                const ad = doc.data();
                grid.innerHTML += `
                    <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-50">
                        <h4 class="font-bold text-secondary">${ad.title}</h4>
                        <button onclick="deleteAd('${doc.id}')" class="text-red-500 text-xs mt-2">Delete</button>
                    </div>`;
            });
        }

        function deleteAd(id) {
            if(confirm("Delete?")) db.collection("posts").doc(id).delete().then(()=>location.reload());
        }

        function logout() {
            auth.signOut().then(() => window.location.href = "index.html");
        }
    </script>
</body>
</html>
