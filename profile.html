<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∂∏‡∂ú‡∑ö ‡∂ú‡∑í‡∂´‡∑î‡∂∏ | Lanka Ads</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { 
            background-color: #f0f2f5; 
            font-family: 'Segoe UI', sans-serif; 
        }
        
        /* Cover Photo */
        .cover-photo { 
            height: 200px; 
            background: linear-gradient(to right, #1877f2, #0056b3); 
            border-radius: 0 0 15px 15px; 
            position: relative;
            overflow: hidden;
        }
        
        .cover-photo::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('https://images.unsplash.com/photo-1556742049-0cfed4f6a45d?auto=format&fit=crop&w=1350&q=80');
            background-size: cover;
            opacity: 0.2;
        }
        
        .cover-edit {
            position: absolute;
            bottom: 15px;
            right: 15px;
            background: rgba(255,255,255,0.9);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            border: none;
            z-index: 10;
        }
        
        /* Profile Picture */
        .profile-pic-container { 
            position: relative; 
            width: 150px; 
            height: 150px; 
            margin-top: -75px; 
            margin-left: 20px;
            z-index: 20;
        }
        
        .profile-pic { 
            width: 100%; 
            height: 100%; 
            border: 5px solid white; 
            border-radius: 50%; 
            object-fit: cover; 
            background: #ddd; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .camera-icon { 
            position: absolute; 
            bottom: 10px; 
            right: 10px; 
            background: #e4e6eb; 
            padding: 10px; 
            border-radius: 50%; 
            cursor: pointer; 
            border: 2px solid white;
            transition: all 0.3s;
        }
        
        .camera-icon:hover {
            background: #d8dadf;
        }
        
        /* Tab Buttons */
        .tab-btn {
            padding: 10px 20px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }
        
        .tab-btn.active {
            color: #1877f2;
            border-bottom-color: #1877f2;
        }
        
        /* Ad Card */
        .ad-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            gap: 15px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.05);
            transition: all 0.3s;
        }
        
        .ad-card:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        
        .ad-card img {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 10px;
        }
        
        /* Settings Card */
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #e4e6eb;
        }
        
        .setting-item:last-child {
            border-bottom: none;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 400px;
            width: 90%;
        }
        
        /* Toast */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #42b72a;
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            display: none;
            z-index: 1001;
        }
    </style>
</head>
<body>

<!-- Navigation -->
<nav class="bg-white shadow-sm sticky top-0 z-50">
    <div class="max-w-6xl mx-auto px-4">
        <div class="flex justify-between items-center h-16">
            <a href="index.html" class="text-2xl font-bold text-blue-600">üá±üá∞ Lanka Ads</a>
            <div class="flex items-center space-x-4">
                <a href="index.html" class="text-gray-600 hover:text-blue-600">
                    <i class="fas fa-home"></i> Home
                </a>
                <a href="post-ad.html" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
                    <i class="fas fa-plus"></i> Post Ad
                </a>
            </div>
        </div>
    </div>
</nav>

<!-- Main Container -->
<div class="max-w-5xl mx-auto px-4 pb-10">
    <!-- Profile Header -->
    <div class="bg-white shadow rounded-b-xl overflow-hidden">
        <!-- Cover Photo -->
        <div class="cover-photo">
            <button class="cover-edit" onclick="alert('Cover photo feature coming soon!')">
                <i class="fas fa-camera mr-2"></i>Edit Cover
            </button>
        </div>
        
        <!-- Profile Info -->
        <div class="px-6 pb-6">
            <div class="flex flex-col sm:flex-row sm:items-end sm:space-x-5">
                <!-- Profile Picture -->
                <div class="profile-pic-container">
                    <img id="user-img" src="https://via.placeholder.com/150" class="profile-pic shadow-lg">
                    <label for="imgUpload" class="camera-icon shadow hover:bg-gray-300 transition">
                        <i class="fas fa-camera"></i>
                    </label>
                    <input type="file" id="imgUpload" class="hidden" accept="image/*">
                </div>
                
                <!-- User Details -->
                <div class="mt-4 text-center sm:text-left flex-1">
                    <h1 id="user-name" class="text-3xl font-bold text-gray-900">Loading...</h1>
                    <p id="user-email" class="text-gray-600">loading...</p>
                    
                    <div class="flex flex-wrap gap-2 mt-3" id="user-badges">
                        <span id="verify-badge" class="hidden bg-blue-100 text-blue-700 text-xs font-bold px-3 py-1 rounded-full">
                            <i class="fas fa-check-circle"></i> Verified
                        </span>
                        <span class="bg-gray-100 text-gray-600 text-xs px-3 py-1 rounded-full">
                            <i class="fas fa-calendar"></i> <span id="join-date">Loading...</span>
                        </span>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="mt-6 flex gap-2 justify-center sm:justify-end">
                    <button id="verify-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg hidden">
                        <i class="fas fa-envelope"></i> Verify Email
                    </button>
                    <button id="logout-btn" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </div>
            
            <!-- Profile Tabs -->
            <div class="flex border-t mt-6 pt-4 gap-4">
                <button class="tab-btn active" onclick="switchTab('posts')">
                    <i class="fas fa-newspaper mr-2"></i>My Ads
                </button>
                <button class="tab-btn" onclick="switchTab('settings')">
                    <i class="fas fa-cog mr-2"></i>Settings
                </button>
                <button class="tab-btn" onclick="switchTab('saved')">
                    <i class="fas fa-bookmark mr-2"></i>Saved Ads
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6">
        <!-- Left Sidebar -->
        <div class="md:col-span-1">
            <!-- Intro Card -->
            <div class="bg-white p-4 shadow rounded-xl">
                <h2 class="text-xl font-bold mb-4">Intro</h2>
                
                <div class="space-y-3">
                    <p id="info-phone" class="text-gray-700">
                        <i class="fas fa-phone text-blue-600 w-6"></i> 
                        <span id="phone-display">Not provided</span>
                    </p>
                    
                    <p id="info-address" class="text-gray-700">
                        <i class="fas fa-map-marker-alt text-blue-600 w-6"></i> 
                        <span id="location-display">Not provided</span>
                    </p>
                    
                    <p class="text-gray-700">
                        <i class="fas fa-clock text-blue-600 w-6"></i> 
                        <span id="last-seen">Online now</span>
                    </p>
                </div>
                
                <button class="w-full bg-gray-200 hover:bg-gray-300 font-semibold py-2 rounded-lg mt-4" onclick="openEditProfileModal()">
                    <i class="fas fa-edit mr-2"></i>Edit Profile
                </button>
            </div>
            
            <!-- Stats Card -->
            <div class="bg-white p-4 shadow rounded-xl mt-4">
                <h2 class="text-xl font-bold mb-4">Statistics</h2>
                
                <div class="space-y-3">
                    <div class="flex justify-between">
                        <span class="text-gray-600">Total Ads</span>
                        <span class="font-bold" id="stat-total">0</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Active Ads</span>
                        <span class="font-bold text-green-600" id="stat-active">0</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Views</span>
                        <span class="font-bold text-blue-600" id="stat-views">0</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Member Since</span>
                        <span class="font-bold" id="stat-member">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Right Content -->
        <div class="md:col-span-2">
            <!-- Posts Tab -->
            <div id="posts-tab" class="bg-white p-4 shadow rounded-xl">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">My Ads</h2>
                    <a href="post-ad.html" class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-green-700">
                        <i class="fas fa-plus"></i> New Ad
                    </a>
                </div>
                
                <div id="my-ads-list" class="space-y-4">
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-spinner fa-spin text-3xl mb-2"></i>
                        <p>Loading your ads...</p>
                    </div>
                </div>
            </div>
            
            <!-- Settings Tab (Hidden) -->
            <div id="settings-tab" class="bg-white p-4 shadow rounded-xl hidden">
                <h2 class="text-xl font-bold mb-4">Account Settings</h2>
                
                <div class="space-y-4">
                    <!-- Email Settings -->
                    <div class="setting-item">
                        <div>
                            <h3 class="font-semibold">Email Address</h3>
                            <p class="text-gray-600 text-sm" id="current-email">loading...</p>
                        </div>
                        <button class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm" onclick="openChangeEmailModal()">
                            Change
                        </button>
                    </div>
                    
                    <!-- Password Settings -->
                    <div class="setting-item">
                        <div>
                            <h3 class="font-semibold">Password</h3>
                            <p class="text-gray-600 text-sm">********</p>
                        </div>
                        <button class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm" onclick="openChangePasswordModal()">
                            Change
                        </button>
                    </div>
                    
                    <!-- Phone Settings -->
                    <div class="setting-item">
                        <div>
                            <h3 class="font-semibold">Phone Number</h3>
                            <p class="text-gray-600 text-sm" id="current-phone">Not provided</p>
                        </div>
                        <button class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm" onclick="openChangePhoneModal()">
                            Update
                        </button>
                    </div>
                    
                    <!-- Delete Account -->
                    <div class="setting-item">
                        <div>
                            <h3 class="font-semibold text-red-600">Delete Account</h3>
                            <p class="text-gray-600 text-sm">Permanently remove your account</p>
                        </div>
                        <button class="bg-red-600 text-white px-4 py-2 rounded-lg text-sm" onclick="openDeleteModal()">
                            Delete
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Saved Tab (Hidden) -->
            <div id="saved-tab" class="bg-white p-4 shadow rounded-xl hidden">
                <h2 class="text-xl font-bold mb-4">Saved Ads</h2>
                <div class="text-center py-8 text-gray-500">
                    <i class="fas fa-bookmark text-4xl mb-2"></i>
                    <p>No saved ads yet</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modals -->
<!-- Edit Profile Modal -->
<div id="editProfileModal" class="modal">
    <div class="modal-content">
        <h3 class="text-xl font-bold mb-4">Edit Profile</h3>
        
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium mb-1">Full Name</label>
                <input type="text" id="edit-name" class="w-full p-2 border rounded-lg">
            </div>
            
            <div>
                <label class="block text-sm font-medium mb-1">Phone Number</label>
                <input type="tel" id="edit-phone" class="w-full p-2 border rounded-lg">
            </div>
            
            <div>
                <label class="block text-sm font-medium mb-1">Location</label>
                <select id="edit-location" class="w-full p-2 border rounded-lg">
                    <option value="">Select District</option>
                    <option value="Colombo">Colombo</option>
                    <option value="Gampaha">Gampaha</option>
                    <option value="Kandy">Kandy</option>
                    <option value="Galle">Galle</option>
                    <option value="Matara">Matara</option>
                </select>
            </div>
        </div>
        
        <div class="flex gap-2 mt-6">
            <button class="flex-1 bg-gray-300 py-2 rounded-lg" onclick="closeModal('editProfileModal')">Cancel</button>
            <button class="flex-1 bg-blue-600 text-white py-2 rounded-lg" onclick="saveProfile()">Save</button>
        </div>
    </div>
</div>

<!-- Change Email Modal -->
<div id="changeEmailModal" class="modal">
    <div class="modal-content">
        <h3 class="text-xl font-bold mb-4">Change Email</h3>
        
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium mb-1">New Email</label>
                <input type="email" id="new-email" class="w-full p-2 border rounded-lg">
            </div>
            
            <div>
                <label class="block text-sm font-medium mb-1">Current Password</label>
                <input type="password" id="email-password" class="w-full p-2 border rounded-lg">
            </div>
        </div>
        
        <div class="flex gap-2 mt-6">
            <button class="flex-1 bg-gray-300 py-2 rounded-lg" onclick="closeModal('changeEmailModal')">Cancel</button>
            <button class="flex-1 bg-blue-600 text-white py-2 rounded-lg" onclick="changeEmail()">Update</button>
        </div>
    </div>
</div>

<!-- Change Password Modal -->
<div id="changePasswordModal" class="modal">
    <div class="modal-content">
        <h3 class="text-xl font-bold mb-4">Change Password</h3>
        
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium mb-1">Current Password</label>
                <input type="password" id="current-password" class="w-full p-2 border rounded-lg">
            </div>
            
            <div>
                <label class="block text-sm font-medium mb-1">New Password</label>
                <input type="password" id="new-password" class="w-full p-2 border rounded-lg">
            </div>
            
            <div>
                <label class="block text-sm font-medium mb-1">Confirm New Password</label>
                <input type="password" id="confirm-password" class="w-full p-2 border rounded-lg">
            </div>
        </div>
        
        <div class="flex gap-2 mt-6">
            <button class="flex-1 bg-gray-300 py-2 rounded-lg" onclick="closeModal('changePasswordModal')">Cancel</button>
            <button class="flex-1 bg-blue-600 text-white py-2 rounded-lg" onclick="changePassword()">Update</button>
        </div>
    </div>
</div>

<!-- Delete Account Modal -->
<div id="deleteModal" class="modal">
    <div class="modal-content">
        <div class="text-center">
            <i class="fas fa-exclamation-triangle text-5xl text-red-500 mb-4"></i>
            <h3 class="text-xl font-bold mb-2">Delete Account?</h3>
            <p class="text-gray-600 mb-4">This action cannot be undone. All your ads will be permanently removed.</p>
            
            <div class="mb-4">
                <input type="password" id="delete-password" class="w-full p-2 border rounded-lg" placeholder="Enter your password to confirm">
            </div>
            
            <div class="flex gap-2">
                <button class="flex-1 bg-gray-300 py-2 rounded-lg" onclick="closeModal('deleteModal')">Cancel</button>
                <button class="flex-1 bg-red-600 text-white py-2 rounded-lg" onclick="deleteAccount()">Delete Forever</button>
            </div>
        </div>
    </div>
</div>

<!-- Toast -->
<div id="toast" class="toast">
    <i class="fas fa-check-circle mr-2"></i>
    <span id="toast-message">Success!</span>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { 
        getAuth, 
        onAuthStateChanged, 
        sendEmailVerification, 
        signOut,
        updateProfile,
        updateEmail,
        updatePassword,
        EmailAuthProvider,
        reauthenticateWithCredential,
        deleteUser
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { 
        getFirestore, 
        collection, 
        query, 
        where, 
        getDocs, 
        deleteDoc, 
        doc, 
        addDoc, 
        serverTimestamp,
        getDoc,
        setDoc,
        updateDoc
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { 
        getStorage, 
        ref, 
        uploadBytes, 
        getDownloadURL 
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

    // Firebase Config
    const firebaseConfig = {
        apiKey: "AIzaSyDtOz0AMlrjcN7xfmkFuhQUU8Zl0MfQMSE",
        authDomain: "adds-ink.firebaseapp.com",
        projectId: "adds-ink",
        storageBucket: "adds-ink.firebasestorage.app",
        messagingSenderId: "638657776631",
        appId: "1:638657776631:web:44ffdad33137bfefa57cf2"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // Current user
    let currentUser = null;

    // Check authentication
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            currentUser = user;
            await loadUserData(user);
            await loadUserAds(user.uid);
            await loadUserStats(user.uid);
        } else {
            window.location.href = "login.html";
        }
    });

    // Load user data
    async function loadUserData(user) {
        // Get user data from Firestore
        const userDoc = await getDoc(doc(db, "users", user.uid));
        let userData = {};
        
        if (userDoc.exists()) {
            userData = userDoc.data();
        } else {
            // Create user document if not exists
            userData = {
                fullName: user.displayName || '',
                email: user.email,
                phone: '',
                location: '',
                createdAt: new Date().toISOString(),
                photoURL: user.photoURL || ''
            };
            await setDoc(doc(db, "users", user.uid), userData);
        }

        // Update UI
        document.getElementById('user-name').innerText = userData.fullName || user.displayName || 'User';
        document.getElementById('user-email').innerText = user.email;
        document.getElementById('current-email').innerText = user.email;
        document.getElementById('current-phone').innerText = userData.phone || 'Not provided';
        document.getElementById('phone-display').innerText = userData.phone || 'Not provided';
        document.getElementById('location-display').innerText = userData.location || 'Not provided';
        
        if (user.photoURL) {
            document.getElementById('user-img').src = user.photoURL;
        }

        // Join date
        if (userData.createdAt) {
            const joinDate = new Date(userData.createdAt);
            document.getElementById('join-date').innerText = joinDate.toLocaleDateString('si-LK');
            document.getElementById('stat-member').innerText = joinDate.toLocaleDateString('si-LK');
        }

        // Email verification
        if (user.emailVerified) {
            document.getElementById('verify-badge').classList.remove('hidden');
        } else {
            document.getElementById('verify-btn').classList.remove('hidden');
        }
    }

    // Load user ads
    async function loadUserAds(uid) {
        const list = document.getElementById('my-ads-list');
        
        try {
            const q = query(collection(db, "posts"), where("authorId", "==", uid));
            const querySnapshot = await getDocs(q);
            
            if (querySnapshot.empty) {
                list.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-box-open text-5xl text-gray-300 mb-3"></i>
                        <p class="text-gray-500">You haven't posted any ads yet.</p>
                        <a href="post-ad.html" class="inline-block mt-4 bg-blue-600 text-white px-6 py-2 rounded-lg">
                            Post Your First Ad
                        </a>
                    </div>
                `;
                return;
            }

            let html = '';
            querySnapshot.forEach((adDoc) => {
                const ad = adDoc.data();
                const adId = adDoc.id;
                
                const statusClass = ad.status === 'approved' ? 'text-green-600' : 'text-yellow-600';
                const statusText = ad.status === 'approved' ? '‚úì Active' : '‚è≥ Pending';
                
                html += `
                    <div class="ad-card">
                        <img src="${ad.imageUrl || 'https://via.placeholder.com/100'}" onerror="this.src='https://via.placeholder.com/100'">
                        <div class="flex-1">
                            <div class="flex justify-between">
                                <h3 class="font-bold text-gray-800">${ad.title || 'Untitled'}</h3>
                                <span class="${statusClass} text-sm font-semibold">${statusText}</span>
                            </div>
                            <p class="text-blue-600 font-bold mt-1">Rs. ${(ad.price || 0).toLocaleString()}</p>
                            <p class="text-gray-500 text-sm mt-1">
                                <i class="fas fa-eye"></i> ${ad.views || 0} views
                            </p>
                            <div class="flex gap-2 mt-3">
                                <button class="text-blue-600 hover:text-blue-800" onclick="editAd('${adId}')">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="text-red-600 hover:text-red-800" onclick="deleteAd('${adId}')">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            list.innerHTML = html;
            
        } catch (error) {
            console.error("Error loading ads:", error);
            list.innerHTML = '<p class="text-center text-red-500">Error loading ads</p>';
        }
    }

    // Load user stats
    async function loadUserStats(uid) {
        try {
            const q = query(collection(db, "posts"), where("authorId", "==", uid));
            const snapshot = await getDocs(q);
            
            let total = 0;
            let active = 0;
            let views = 0;
            
            snapshot.forEach((doc) => {
                total++;
                const ad = doc.data();
                if (ad.status === 'approved') active++;
                views += ad.views || 0;
            });
            
            document.getElementById('stat-total').innerText = total;
            document.getElementById('stat-active').innerText = active;
            document.getElementById('stat-views').innerText = views;
            
        } catch (error) {
            console.error("Error loading stats:", error);
        }
    }

    // Profile photo upload
    document.getElementById('imgUpload').onchange = async (e) => {
        const file = e.target.files[0];
        if(!file || !currentUser) return;

        try {
            showToast('Uploading...');
            
            const storageRef = ref(storage, 'profiles/' + currentUser.uid);
            await uploadBytes(storageRef, file);
            const url = await getDownloadURL(storageRef);
            
            await updateProfile(currentUser, { photoURL: url });
            await updateDoc(doc(db, "users", currentUser.uid), { photoURL: url });
            
            document.getElementById('user-img').src = url;
            showToast('Profile photo updated!');
            
        } catch (error) {
            showToast('Error: ' + error.message, 'error');
        }
    };

    // Tab switching
    window.switchTab = (tab) => {
        // Update tab buttons
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        
        // Show/hide tabs
        document.getElementById('posts-tab').classList.add('hidden');
        document.getElementById('settings-tab').classList.add('hidden');
        document.getElementById('saved-tab').classList.add('hidden');
        
        document.getElementById(tab + '-tab').classList.remove('hidden');
    };

    // Modal functions
    window.openEditProfileModal = () => {
        document.getElementById('edit-name').value = document.getElementById('user-name').innerText;
        document.getElementById('edit-phone').value = document.getElementById('phone-display').innerText;
        openModal('editProfileModal');
    };

    window.saveProfile = async () => {
        const name = document.getElementById('edit-name').value;
        const phone = document.getElementById('edit-phone').value;
        const location = document.getElementById('edit-location').value;
        
        try {
            await updateProfile(currentUser, { displayName: name });
            await updateDoc(doc(db, "users", currentUser.uid), {
                fullName: name,
                phone: phone,
                location: location
            });
            
            document.getElementById('user-name').innerText = name;
            document.getElementById('phone-display').innerText = phone || 'Not provided';
            document.getElementById('location-display').innerText = location || 'Not provided';
            document.getElementById('current-phone').innerText = phone || 'Not provided';
            
            closeModal('editProfileModal');
            showToast('Profile updated!');
            
        } catch (error) {
            showToast('Error: ' + error.message, 'error');
        }
    };

    window.openChangeEmailModal = () => openModal('changeEmailModal');
    
    window.changeEmail = async () => {
        const newEmail = document.getElementById('new-email').value;
        const password = document.getElementById('email-password').value;
        
        try {
            const credential = EmailAuthProvider.credential(currentUser.email, password);
            await reauthenticateWithCredential(currentUser, credential);
            await updateEmail(currentUser, newEmail);
            await updateDoc(doc(db, "users", currentUser.uid), { email: newEmail });
            
            document.getElementById('user-email').innerText = newEmail;
            document.getElementById('current-email').innerText = newEmail;
            
            closeModal('changeEmailModal');
            showToast('Email updated!');
            
        } catch (error) {
            showToast('Error: ' + error.message, 'error');
        }
    };

    window.openChangePasswordModal = () => openModal('changePasswordModal');
    
    window.changePassword = async () => {
        const current = document.getElementById('current-password').value;
        const newPass = document.getElementById('new-password').value;
        const confirm = document.getElementById('confirm-password').value;
        
        if (newPass !== confirm) {
            showToast('Passwords do not match!', 'error');
            return;
        }
        
        try {
            const credential = EmailAuthProvider.credential(currentUser.email, current);
            await reauthenticateWithCredential(currentUser, credential);
            await updatePassword(currentUser, newPass);
            
            closeModal('changePasswordModal');
            showToast('Password updated!');
            
        } catch (error) {
            showToast('Error: ' + error.message, 'error');
        }
    };

    window.openChangePhoneModal = () => {
        document.getElementById('edit-phone').value = document.getElementById('phone-display').innerText;
        openModal('editProfileModal');
    };

    window.openDeleteModal = () => openModal('deleteModal');
    
    window.deleteAccount = async () => {
        const password = document.getElementById('delete-password').value;
        
        try {
            const credential = EmailAuthProvider.credential(currentUser.email, password);
            await reauthenticateWithCredential(currentUser, credential);
            
            // Delete user's ads
            const adsQuery = query(collection(db, "posts"), where("authorId", "==", currentUser.uid));
            const adsSnapshot = await getDocs(adsQuery);
            adsSnapshot.forEach(async (adDoc) => {
                await deleteDoc(doc(db, "posts", adDoc.id));
            });
            
            // Delete user document
            await deleteDoc(doc(db, "users", currentUser.uid));
            
            // Delete user
            await deleteUser(currentUser);
            
            window.location.href = 'signup.html';
            
        } catch (error) {
            showToast('Error: ' + error.message, 'error');
        }
    };

    // Ad actions
    window.editAd = (adId) => {
        window.location.href = `edit-ad.html?id=${adId}`;
    };

    window.deleteAd = async (adId) => {
        if (confirm('Delete this ad?')) {
            await deleteDoc(doc(db, "posts", adId));
            await loadUserAds(currentUser.uid);
            await loadUserStats(currentUser.uid);
            showToast('Ad deleted!');
        }
    };

    // Logout
    document.getElementById('logout-btn').onclick = async () => {
        await signOut(auth);
        window.location.href = 'login.html';
    };

    // Verify email
    document.getElementById('verify-btn').onclick = async () => {
        await sendEmailVerification(currentUser);
        showToast('Verification email sent!');
    };

    // Utility functions
    function openModal(id) {
        document.getElementById(id).style.display = 'flex';
    }

    window.closeModal = (id) => {
        document.getElementById(id).style.display = 'none';
    };

    function showToast(message, type = 'success') {
        const toast = document.getElementById('toast');
        const msg = document.getElementById('toast-message');
        
        toast.style.background = type === 'success' ? '#42b72a' : '#f44336';
        msg.innerText = message;
        toast.style.display = 'flex';
        
        setTimeout(() => {
            toast.style.display = 'none';
        }, 3000);
    }

    // Close modals when clicking outside
    window.onclick = (event) => {
        if (event.target.classList.contains('modal')) {
            event.target.style.display = 'none';
        }
    };
</script>

</body>
</html>