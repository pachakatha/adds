<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile | LankaAds</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); }
    </style>
</head>
<body class="bg-slate-50 font-sans text-gray-800">

    <div id="otpModal" class="modal flex items-center justify-center">
        <div class="bg-white p-8 rounded-3xl shadow-2xl max-w-sm w-full mx-4">
            <h3 class="text-xl font-bold text-secondary mb-2">OTP ‡∂ë‡∂ö ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±</h3>
            <p class="text-xs text-gray-500 mb-6">‡∂î‡∂∂‡∑ö ‡∂Ø‡∑î‡∂ª‡∂ö‡∂Æ‡∂±‡∂∫‡∂ß ‡∂Ω‡∑ê‡∂∂‡∑î‡∂´‡∑î ‡∂Ö‡∂Ç‡∂ö 6 ‡∂ö‡∑ö‡∂≠‡∂∫ ‡∂∏‡∑ô‡∑Ñ‡∑í ‡∂ß‡∂∫‡∑í‡∂¥‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±.</p>
            <input type="text" id="otpCode" placeholder="- - - - - -" class="w-full text-center text-2xl tracking-widest p-4 bg-gray-50 border-2 border-gray-100 rounded-2xl outline-none focus:border-primary mb-4">
            <button onclick="confirmOTP()" class="w-full bg-primary text-white py-4 rounded-2xl font-bold shadow-lg">‡∂≠‡∑Ñ‡∑Ä‡∑î‡∂ª‡∑î ‡∂ö‡∂ª‡∂±‡∑ä‡∂± (Verify)</button>
            <button onclick="closeModal()" class="w-full text-gray-400 mt-4 text-sm font-semibold">‡∂Ö‡∑Ä‡∂Ω‡∂Ç‡∂ú‡∑î ‡∂ö‡∂ª‡∂±‡∑ä‡∂±</button>
        </div>
    </div>

    <nav class="bg-white shadow-sm px-6 py-4 flex justify-between items-center sticky top-0 z-50">
        <a href="index.html" class="text-2xl font-bold text-secondary flex items-center gap-2">
            <span class="bg-primary text-white p-2 rounded-lg text-lg">LA</span> LankaAds
        </a>
        <button onclick="logout()" class="text-red-500 font-bold text-sm bg-red-50 px-4 py-2 rounded-xl">Logout</button>
    </nav>

    <div class="container mx-auto px-4 py-8 max-w-5xl">
        <div class="bg-white rounded-[2.5rem] p-8 shadow-xl border border-gray-50 mb-8 flex flex-col md:flex-row items-center gap-8">
            <div class="relative">
                <div class="w-28 h-28 bg-gradient-to-tr from-secondary to-blue-400 text-white rounded-full flex items-center justify-center text-4xl font-bold shadow-inner">
                    <span id="user-initial">U</span>
                </div>
                <div id="completion-label" class="absolute -bottom-2 -right-2 bg-primary text-white text-[10px] font-bold px-3 py-1 rounded-full shadow-md">0% Done</div>
            </div>
            <div class="flex-grow text-center md:text-left">
                <h2 id="user-email" class="text-2xl font-extrabold text-secondary">Loading...</h2>
                <div class="flex flex-wrap gap-2 mt-3 justify-center md:justify-start">
                    <span id="email-badge" class="px-3 py-1 rounded-full text-[10px] font-bold">Checking...</span>
                    <span id="phone-badge" class="px-3 py-1 rounded-full text-[10px] font-bold">Checking...</span>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2 space-y-8">
                <div class="bg-white rounded-[2rem] p-8 shadow-lg border border-gray-50">
                    <h3 class="text-xl font-bold text-secondary mb-6 flex items-center gap-2">üë§ ‡∂¥‡∑î‡∂Ø‡∑ä‡∂ú‡∂Ω‡∑í‡∂ö ‡∂≠‡∑ú‡∂ª‡∂≠‡∑î‡∂ª‡∑î</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-gray-400 ml-2 uppercase">‡∑É‡∂∏‡∑ä‡∂¥‡∑ñ‡∂ª‡∑ä‡∂´ ‡∂±‡∂∏</label>
                            <input type="text" id="fullname" class="w-full p-4 bg-gray-50 rounded-2xl outline-none focus:ring-2 focus:ring-primary/20 border border-transparent">
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-gray-400 ml-2 uppercase">‡∂ã‡∂¥‡∂±‡∑ä ‡∂Ø‡∑í‡∂±‡∂∫</label>
                            <input type="date" id="dob" class="w-full p-4 bg-gray-50 rounded-2xl outline-none border border-transparent">
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-gray-400 ml-2 uppercase">‡∂¥‡∑Ö‡∑è‡∂≠</label>
                            <input type="text" id="province" class="w-full p-4 bg-gray-50 rounded-2xl outline-none border border-transparent">
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-gray-400 ml-2 uppercase">‡∂Ø‡∑í‡∑É‡∑ä‡∂≠‡∑ä‚Äç‡∂ª‡∑í‡∂ö‡∑ä‡∂ö‡∂∫</label>
                            <input type="text" id="district" class="w-full p-4 bg-gray-50 rounded-2xl outline-none border border-transparent">
                        </div>
                        <div class="space-y-1 md:col-span-2">
                            <label class="text-[10px] font-bold text-gray-400 ml-2 uppercase">‡∂Ω‡∑í‡∂¥‡∑í‡∂±‡∂∫</label>
                            <textarea id="address" rows="2" class="w-full p-4 bg-gray-50 rounded-2xl outline-none border border-transparent"></textarea>
                        </div>
                    </div>
                    <button onclick="saveProfile()" class="w-full mt-8 bg-secondary text-white py-4 rounded-2xl font-bold hover:shadow-lg transition-all active:scale-[0.98]">‡∂≠‡∑ú‡∂ª‡∂≠‡∑î‡∂ª‡∑î ‡∑É‡∑î‡∂ª‡∂ö‡∑í‡∂±‡∑ä‡∂±</button>
                </div>
            </div>

            <div class="space-y-8">
                <div class="bg-white rounded-[2rem] p-8 shadow-lg border border-gray-50">
                    <h3 class="text-xl font-bold text-secondary mb-6">üîí ‡∂≠‡∑Ñ‡∑Ä‡∑î‡∂ª‡∑î ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∑ä</h3>
                    
                    <div class="p-4 bg-slate-50 rounded-2xl mb-4">
                        <p class="text-xs font-bold text-gray-400 mb-2 uppercase">Email Verification</p>
                        <div id="email-verify-box">
                            <button id="verify-email-btn" onclick="sendEmailVerification()" class="hidden w-full bg-primary text-white py-2 rounded-xl text-xs font-bold">Verify Now</button>
                            <p class="text-[9px] text-gray-400 mt-2 italic">*Spam folder ‡∂ë‡∂ö ‡∂¥‡∂ª‡∑ì‡∂ö‡∑ä‡∑Ç‡∑è ‡∂ö‡∂ª‡∂±‡∑ä‡∂±.</p>
                        </div>
                    </div>

                    <div class="p-4 bg-slate-50 rounded-2xl">
                        <p class="text-xs font-bold text-gray-400 mb-2 uppercase">Phone Verification</p>
                        <div id="phone-verify-box">
                            <input type="tel" id="phoneNumber" placeholder="+947XXXXXXXX" class="w-full p-3 bg-white rounded-xl text-sm border border-gray-100 mb-3 outline-none">
                            <div id="recaptcha-container"></div>
                            <button onclick="requestOTP()" class="w-full bg-secondary text-white py-2 rounded-xl text-xs font-bold">Send OTP</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <h3 class="text-xl font-bold text-secondary mt-12 mb-6">üìã ‡∂∏‡∂ú‡∑ö ‡∂Ø‡∑ê‡∂±‡∑ä‡∑Ä‡∑ì‡∂∏‡∑ä</h3>
        <div id="my-ads-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBvTTRbiSEyuYi7XCM5_tHvjaZzaFN_8IQ",
            authDomain: "add-ink.firebaseapp.com",
            projectId: "add-ink",
            storageBucket: "add-ink.firebasestorage.app",
            messagingSenderId: "752189116425",
            appId: "1:752189116425:web:0acf6e7b3f6b3629e3e8d8"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let currentResult;

        auth.onAuthStateChanged(user => {
            if (user) {
                document.getElementById('user-email').innerText = user.email;
                document.getElementById('user-initial').innerText = user.email.charAt(0).toUpperCase();
                updateBadges(user);
                loadProfileData(user.uid);
                loadMyAds(user.uid);
            } else {
                window.location.href = "login.html";
            }
        });

        function updateBadges(user) {
            const eBadge = document.getElementById('email-badge');
            const pBadge = document.getElementById('phone-badge');
            
            if (user.emailVerified) {
                eBadge.innerText = "Email Verified";
                eBadge.className = "px-3 py-1 rounded-full text-[10px] font-bold bg-green-100 text-green-600";
                document.getElementById('verify-email-btn').classList.add('hidden');
            } else {
                eBadge.innerText = "Email Unverified";
                eBadge.className = "px-3 py-1 rounded-full text-[10px] font-bold bg-red-100 text-red-600";
                document.getElementById('verify-email-btn').classList.remove('hidden');
            }

            const phoneProvider = user.providerData.find(p => p.providerId === 'phone');
            if (phoneProvider) {
                pBadge.innerText = "Phone Verified";
                pBadge.className = "px-3 py-1 rounded-full text-[10px] font-bold bg-blue-100 text-blue-600";
                document.getElementById('phone-verify-box').innerHTML = "<p class='text-xs text-green-600 font-bold'>Verified: " + phoneProvider.phoneNumber + "</p>";
            } else {
                pBadge.innerText = "Phone Unverified";
                pBadge.className = "px-3 py-1 rounded-full text-[10px] font-bold bg-slate-200 text-slate-500";
            }
        }

        async function saveProfile() {
            const uid = auth.currentUser.uid;
            const data = {
                fullname: document.getElementById('fullname').value,
                dob: document.getElementById('dob').value,
                province: document.getElementById('province').value,
                district: document.getElementById('district').value,
                address: document.getElementById('address').value
            };
            await db.collection("users").doc(uid).set(data, { merge: true });
            alert("‡∂≠‡∑ú‡∂ª‡∂≠‡∑î‡∂ª‡∑î ‡∑É‡∑î‡∂ª‡∑ê‡∂ö‡∑ì‡∂∏ ‡∑É‡∑è‡∂ª‡∑ä‡∂Æ‡∂ö‡∂∫‡∑í!");
            location.reload();
        }

        async function loadProfileData(uid) {
            const doc = await db.collection("users").doc(uid).get();
            if (doc.exists) {
                const data = doc.data();
                document.getElementById('fullname').value = data.fullname || '';
                document.getElementById('dob').value = data.dob || '';
                document.getElementById('province').value = data.province || '';
                document.getElementById('district').value = data.district || '';
                document.getElementById('address').value = data.address || '';
                
                // Calculate Completion
                const fields = [data.fullname, data.dob, data.province, data.district, data.address];
                const filled = fields.filter(f => f).length;
                const percent = Math.round((filled / fields.length) * 100);
                document.getElementById('completion-label').innerText = percent + "% Done";
            }
        }

        // --- OTP Logic ---
        function requestOTP() {
            const num = document.getElementById('phoneNumber').value;
            if(!num.startsWith('+94')) { alert("‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª +947... ‡∂Ω‡∑ô‡∑É ‡∂Ö‡∂Ç‡∂ö‡∂∫ ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±"); return; }

            window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {'size': 'invisible'});
            auth.currentUser.linkWithPhoneNumber(num, window.recaptchaVerifier)
                .then(result => {
                    currentResult = result;
                    document.getElementById('otpModal').style.display = 'flex';
                }).catch(err => alert("OTP ‡∂Ø‡∑ù‡∑Ç‡∂∫‡∂ö‡∑í: " + err.message));
        }

        function confirmOTP() {
            const code = document.getElementById('otpCode').value;
            currentResult.confirm(code).then(() => {
                alert("‡∂Ø‡∑î‡∂ª‡∂ö‡∂Æ‡∂± ‡∂Ö‡∂Ç‡∂ö‡∂∫ ‡∑É‡∑è‡∂ª‡∑ä‡∂Æ‡∂ö‡∑Ä ‡∑É‡∂∏‡∑ä‡∂∂‡∂±‡∑ä‡∂∞ ‡∂ö‡∑Ö‡∑è!");
                location.reload();
            }).catch(() => alert("‡∑Ä‡∑ê‡∂ª‡∂Ø‡∑í OTP ‡∂Ö‡∂Ç‡∂ö‡∂∫‡∂ö‡∑í. ‡∂±‡∑ê‡∑Ä‡∂≠ ‡∂ã‡∂≠‡∑ä‡∑É‡∑è‡∑Ñ ‡∂ö‡∂ª‡∂±‡∑ä‡∂±."));
        }

        function closeModal() { document.getElementById('otpModal').style.display = 'none'; }

        function sendEmailVerification() {
            auth.currentUser.sendEmailVerification().then(() => alert("Email ‡∂ë‡∂ö ‡∂¥‡∂ª‡∑ì‡∂ö‡∑ä‡∑Ç‡∑è ‡∂ö‡∂ª‡∂±‡∑ä‡∂± (Inbox/Spam)."));
        }

        async function loadMyAds(uid) {
            const grid = document.getElementById('my-ads-grid');
            const snap = await db.collection("posts").where("userId", "==", uid).get();
            grid.innerHTML = snap.empty ? "<p class='col-span-full text-center py-10 text-gray-400'>‡∂Ø‡∑ê‡∂±‡∑ä‡∑Ä‡∑ì‡∂∏‡∑ä ‡∂ö‡∑í‡∑É‡∑í‡∑Ä‡∂ö‡∑ä ‡∂±‡∑ê‡∂≠.</p>" : "";
            snap.forEach(doc => {
                const ad = doc.data();
                grid.innerHTML += `
                    <div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-50">
                        <h4 class="font-bold text-secondary mb-4">${ad.title}</h4>
                        <button onclick="deleteAd('${doc.id}')" class="text-red-500 text-xs font-bold hover:underline">‡∂â‡∑Ä‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±</button>
                    </div>`;
            });
        }

        function deleteAd(id) { if(confirm("Delete?")) db.collection("posts").doc(id).delete().then(()=>location.reload()); }
        function logout() { auth.signOut().then(() => window.location.href = "index.html"); }
    </script>
</body>
</html>
