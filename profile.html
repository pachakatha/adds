<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile | LankaAds</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        /* ‡∂Ü‡∂ª‡∂∏‡∑ä‡∂∑‡∂∫‡∑ö‡∂Ø‡∑ì Popup ‡∂ë‡∂ö ‡∑É‡∂ü‡∑Ä‡∑è ‡∂≠‡∑ê‡∂∂‡∑ì‡∂∏‡∂ß */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(8px); }
    </style>
</head>
<body class="bg-slate-50 font-sans text-gray-800">

    <div id="otpModal" class="modal flex items-center justify-center">
        <div class="bg-white p-8 rounded-[2rem] shadow-2xl max-w-sm w-full mx-4">
            <h3 class="text-xl font-bold text-secondary mb-2">OTP ‡∂ö‡∑ö‡∂≠‡∂∫ ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±</h3>
            <p class="text-[10px] text-gray-500 mb-6 uppercase tracking-wider">‡∂Ø‡∑î‡∂ª‡∂ö‡∂Æ‡∂±‡∂∫‡∂ß ‡∂Ω‡∑ê‡∂∂‡∑î‡∂´‡∑î ‡∂Ö‡∂Ç‡∂ö 6 ‡∂∏‡∑ô‡∑Ñ‡∑í ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±</p>
            <input type="text" id="otpCode" placeholder="......" class="w-full text-center text-3xl tracking-[10px] p-4 bg-gray-50 border-2 border-gray-100 rounded-2xl outline-none focus:border-primary mb-6">
            <button onclick="confirmOTP()" class="w-full bg-primary text-white py-4 rounded-2xl font-bold shadow-lg hover:bg-orange-600 transition">‡∂≠‡∑Ñ‡∑Ä‡∑î‡∂ª‡∑î ‡∂ö‡∂ª‡∂±‡∑ä‡∂±</button>
            <button onclick="closeModal()" class="w-full text-gray-400 mt-4 text-xs font-semibold hover:text-gray-600">‡∂Ö‡∑Ä‡∂Ω‡∂Ç‡∂ú‡∑î ‡∂ö‡∂ª‡∂±‡∑ä‡∂±</button>
        </div>
    </div>

    <nav class="bg-white shadow-sm px-6 py-4 flex justify-between items-center sticky top-0 z-50">
        <a href="index.html" class="text-2xl font-bold text-secondary flex items-center gap-2 italic">
            <span class="bg-primary text-white px-2 rounded-lg not-italic">LA</span> LankaAds
        </a>
        <button onclick="logout()" class="text-red-500 font-bold text-xs bg-red-50 px-4 py-2 rounded-xl border border-red-100">Logout</button>
    </nav>

    <div class="container mx-auto px-4 py-8 max-w-5xl">
        <div class="bg-white rounded-[2.5rem] p-10 shadow-xl border border-gray-100 mb-8 flex flex-col md:flex-row items-center gap-8 relative overflow-hidden">
            <div class="relative z-10">
                <img id="profile-pic" src="https://via.placeholder.com/150" class="w-32 h-32 rounded-full object-cover border-4 border-white shadow-2xl">
                <label for="file-upload" class="absolute bottom-1 right-1 bg-primary text-white p-2 rounded-full cursor-pointer shadow-lg hover:scale-110 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" /></svg>
                </label>
                <input id="file-upload" type="file" accept="image/*" class="hidden" onchange="previewImage(event)">
                <div id="membership-badge" class="absolute -top-3 -left-3 text-white text-[10px] font-bold px-4 py-1.5 rounded-full shadow-lg transform -rotate-12">Silver</div>
            </div>
            
            <div class="flex-grow text-center md:text-left z-10">
                <h2 id="user-email" class="text-3xl font-black text-secondary tracking-tight">Loading...</h2>
                <div class="flex flex-wrap gap-3 mt-4 justify-center md:justify-start">
                    <span id="email-badge" class="px-4 py-1.5 rounded-full text-[10px] font-bold shadow-sm">...</span>
                    <span id="phone-badge" class="px-4 py-1.5 rounded-full text-[10px] font-bold shadow-sm">...</span>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2 space-y-8">
                <div class="bg-white rounded-[2rem] p-10 shadow-xl border border-gray-100">
                    <h3 class="text-xl font-bold text-secondary mb-8 flex items-center gap-3">
                        <span class="p-2 bg-blue-50 rounded-lg text-blue-500">üë§</span> ‡∂¥‡∑î‡∂Ø‡∑ä‡∂ú‡∂Ω‡∑í‡∂ö ‡∂≠‡∑ú‡∂ª‡∂≠‡∑î‡∂ª‡∑î
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-2">
                            <label class="text-[11px] font-bold text-gray-400 ml-2 uppercase">‡∑É‡∂∏‡∑ä‡∂¥‡∑ñ‡∂ª‡∑ä‡∂´ ‡∂±‡∂∏</label>
                            <input type="text" id="fullname" class="w-full p-4 bg-gray-50 rounded-2xl outline-none focus:ring-2 focus:ring-primary/20 border-2 border-transparent focus:border-primary/20 transition">
                        </div>
                        <div class="space-y-2">
                            <label class="text-[11px] font-bold text-gray-400 ml-2 uppercase">‡∂ã‡∂¥‡∂±‡∑ä ‡∂Ø‡∑í‡∂±‡∂∫</label>
                            <input type="date" id="dob" class="w-full p-4 bg-gray-50 rounded-2xl outline-none border-2 border-transparent transition text-gray-500">
                        </div>
                        <div class="space-y-2">
                            <label class="text-[11px] font-bold text-gray-400 ml-2 uppercase">‡∂¥‡∑Ö‡∑è‡∂≠</label>
                            <input type="text" id="province" class="w-full p-4 bg-gray-50 rounded-2xl outline-none border-2 border-transparent transition">
                        </div>
                        <div class="space-y-2">
                            <label class="text-[11px] font-bold text-gray-400 ml-2 uppercase">‡∂Ø‡∑í‡∑É‡∑ä‡∂≠‡∑ä‚Äç‡∂ª‡∑í‡∂ö‡∑ä‡∂ö‡∂∫</label>
                            <input type="text" id="district" class="w-full p-4 bg-gray-50 rounded-2xl outline-none border-2 border-transparent transition">
                        </div>
                        <div class="space-y-2 md:col-span-2">
                            <label class="text-[11px] font-bold text-gray-400 ml-2 uppercase">‡∂Ω‡∑í‡∂¥‡∑í‡∂±‡∂∫</label>
                            <textarea id="address" rows="3" class="w-full p-4 bg-gray-50 rounded-2xl outline-none border-2 border-transparent transition"></textarea>
                        </div>
                    </div>
                    <button onclick="saveProfile()" class="w-full mt-10 bg-secondary text-white py-5 rounded-2xl font-bold hover:shadow-2xl transition-all active:scale-[0.98] text-lg">‡∂≠‡∑ú‡∂ª‡∂≠‡∑î‡∂ª‡∑î ‡∑É‡∑î‡∂ª‡∂ö‡∑í‡∂±‡∑ä‡∂±</button>
                </div>
            </div>

            <div class="space-y-8">
                <div class="bg-white rounded-[2rem] p-8 shadow-xl border border-gray-100">
                    <h3 class="text-xl font-bold text-secondary mb-8">üîí ‡∂≠‡∑Ñ‡∑Ä‡∑î‡∂ª‡∑î ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∑ä</h3>
                    <div class="p-6 bg-slate-50 rounded-3xl mb-6 border border-slate-100">
                        <p class="text-xs font-bold text-gray-400 mb-4 uppercase tracking-tighter text-center">Email Verification</p>
                        <div id="email-verify-box">
                            <button id="verify-email-btn" onclick="sendEmailVerification()" class="hidden w-full bg-primary text-white py-3 rounded-2xl text-xs font-bold shadow-md hover:scale-[1.02] transition">Verify Now</button>
                            <p class="text-[9px] text-gray-400 mt-4 text-center leading-relaxed font-medium">*Spam folder ‡∂ë‡∂ö ‡∂Ö‡∂±‡∑í‡∑Ä‡∑è‡∂ª‡∑ä‡∂∫‡∂∫‡∑ô‡∂±‡∑ä‡∂∏ ‡∂¥‡∂ª‡∑ì‡∂ö‡∑ä‡∑Ç‡∑è ‡∂ö‡∂ª‡∂±‡∑ä‡∂±.</p>
                        </div>
                    </div>
                    <div class="p-6 bg-slate-50 rounded-3xl border border-slate-100">
                        <p class="text-xs font-bold text-gray-400 mb-4 uppercase tracking-tighter text-center">Phone Verification</p>
                        <div id="phone-verify-box">
                            <input type="tel" id="phoneNumber" placeholder="+947XXXXXXXX" class="w-full p-4 bg-white rounded-2xl text-sm border border-gray-200 mb-4 outline-none focus:border-primary text-center font-bold">
                            <div id="recaptcha-container"></div>
                            <button id="send-otp-btn" onclick="requestOTP()" class="w-full bg-secondary text-white py-3 rounded-2xl text-xs font-bold shadow-md hover:scale-[1.02] transition">Send OTP</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBvTTRbiSEyuYi7XCM5_tHvjaZzaFN_8IQ",
            authDomain: "add-ink.firebaseapp.com",
            projectId: "add-ink",
            storageBucket: "add-ink.firebasestorage.app",
            messagingSenderId: "752189116425",
            appId: "1:752189116425:web:0acf6e7b3f6b3629e3e8d8"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let currentResult;

        auth.onAuthStateChanged(user => {
            if (user) {
                document.getElementById('user-email').innerText = user.email;
                updateBadges(user);
                loadProfileData(user.uid);
            } else {
                window.location.href = "login.html";
            }
        });

        function previewImage(event) {
            const reader = new FileReader();
            reader.onload = function() {
                const output = document.getElementById('profile-pic');
                output.src = reader.result;
                localStorage.setItem('profilePic_' + auth.currentUser.uid, reader.result);
            }
            reader.readAsDataURL(event.target.files[0]);
        }

        function updateBadges(user) {
            const eBadge = document.getElementById('email-badge');
            const pBadge = document.getElementById('phone-badge');
            
            const savedPic = localStorage.getItem('profilePic_' + user.uid);
            if(savedPic) document.getElementById('profile-pic').src = savedPic;

            if (user.emailVerified) {
                eBadge.innerText = "‚úì EMAIL VERIFIED";
                eBadge.className = "px-4 py-1.5 rounded-full text-[10px] font-bold bg-green-50 text-green-600 border border-green-100";
                document.getElementById('verify-email-btn').style.display = 'none';
            } else {
                eBadge.innerText = "‚ö† EMAIL UNVERIFIED";
                eBadge.className = "px-4 py-1.5 rounded-full text-[10px] font-bold bg-red-50 text-red-600 border border-red-100";
                document.getElementById('verify-email-btn').classList.remove('hidden');
            }

            const phoneProvider = user.providerData.find(p => p.providerId === 'phone');
            if (phoneProvider) {
                pBadge.innerText = "‚úì PHONE VERIFIED";
                pBadge.className = "px-4 py-1.5 rounded-full text-[10px] font-bold bg-blue-50 text-blue-600 border border-blue-100";
                document.getElementById('phone-verify-box').innerHTML = "<div class='text-center py-2'><p class='text-xs text-green-600 font-bold'>Connected: " + phoneProvider.phoneNumber + "</p></div>";
            } else {
                pBadge.innerText = "‚ö† PHONE UNVERIFIED";
                pBadge.className = "px-4 py-1.5 rounded-full text-[10px] font-bold bg-slate-100 text-slate-500 border border-slate-200";
            }
        }

        async function saveProfile() {
            const data = {
                fullname: document.getElementById('fullname').value,
                dob: document.getElementById('dob').value,
                province: document.getElementById('province').value,
                district: document.getElementById('district').value,
                address: document.getElementById('address').value
            };
            await db.collection("users").doc(auth.currentUser.uid).set(data, { merge: true });
            alert("‡∂≠‡∑ú‡∂ª‡∂≠‡∑î‡∂ª‡∑î ‡∑É‡∑î‡∂ª‡∑ê‡∂ö‡∑ì‡∂∏ ‡∑É‡∑è‡∂ª‡∑ä‡∂Æ‡∂ö‡∂∫‡∑í!");
            location.reload();
        }

        async function loadProfileData(uid) {
            const doc = await db.collection("users").doc(uid).get();
            if (doc.exists) {
                const data = doc.data();
                document.getElementById('fullname').value = data.fullname || '';
                document.getElementById('dob').value = data.dob || '';
                document.getElementById('province').value = data.province || '';
                document.getElementById('district').value = data.district || '';
                document.getElementById('address').value = data.address || '';
                
                const fields = [data.fullname, data.dob, data.province, data.district, data.address];
                const filled = fields.filter(f => f && f.length > 0).length;
                const percent = Math.round((filled / fields.length) * 100);
                
                let level = "Silver"; let color = "bg-slate-400";
                if (percent >= 60) { level = "Gold"; color = "bg-yellow-500"; }
                if (percent >= 100) { level = "Platinum"; color = "bg-cyan-500"; }

                const badge = document.getElementById('membership-badge');
                badge.innerText = level;
                badge.className = `absolute -top-3 -left-3 text-white text-[10px] font-bold px-4 py-1.5 rounded-full shadow-lg transform -rotate-12 ${color}`;
            }
        }

        function requestOTP() {
            const num = document.getElementById('phoneNumber').value;
            const btn = document.getElementById('send-otp-btn');
            if(!num.startsWith('+94') || num.length < 12) { alert("‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª +947XXXXXXXX ‡∂Ω‡∑ô‡∑É ‡∂Ö‡∂Ç‡∂ö‡∂∫ ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±"); return; }

            btn.disabled = true; btn.innerText = "‡∂∫‡∑Ä‡∂∏‡∑í‡∂±‡∑ä...";

            window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {'size': 'invisible'});
            auth.currentUser.linkWithPhoneNumber(num, window.recaptchaVerifier)
                .then(result => {
                    currentResult = result;
                    document.getElementById('otpModal').style.display = 'flex';
                    btn.disabled = false; btn.innerText = "Send OTP";
                }).catch(err => {
                    alert("OTP ‡∂Ø‡∑ù‡∑Ç‡∂∫‡∂ö‡∑í: " + err.message);
                    btn.disabled = false; btn.innerText = "Send OTP";
                });
        }

        function confirmOTP() {
            const code = document.getElementById('otpCode').value;
            currentResult.confirm(code).then(() => {
                alert("‡∂Ø‡∑î‡∂ª‡∂ö‡∂Æ‡∂± ‡∂Ö‡∂Ç‡∂ö‡∂∫ ‡∑É‡∑è‡∂ª‡∑ä‡∂Æ‡∂ö‡∑Ä ‡∑É‡∂∏‡∑ä‡∂∂‡∂±‡∑ä‡∂∞ ‡∂ö‡∑Ö‡∑è!");
                location.reload();
            }).catch(() => alert("‡∑Ä‡∑ê‡∂ª‡∂Ø‡∑í OTP ‡∂Ö‡∂Ç‡∂ö‡∂∫‡∂ö‡∑í."));
        }

        function closeModal() { document.getElementById('otpModal').style.display = 'none'; }
        function sendEmailVerification() { auth.currentUser.sendEmailVerification().then(() => alert("Email ‡∂ë‡∂ö ‡∂¥‡∂ª‡∑ì‡∂ö‡∑ä‡∑Ç‡∑è ‡∂ö‡∂ª‡∂±‡∑ä‡∂± (Inbox/Spam).")); }
        function logout() { auth.signOut().then(() => window.location.href = "index.html"); }
    </script>
</body>
</html>
